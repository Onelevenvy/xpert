<div class="w-full h-full flex flex-col justify-between items-stretch">
  <div class="ngm-kpi--kpi flex-1 flex justify-center items-center">
    @if (options?.icon) {
      <mat-icon>{{options.icon}}</mat-icon>
    }
    
    <ng-content select=".ngm-kpi--icon"></ng-content>

    @if (kpiValue$ | async; as kpiValue) {
      <div class="ngm-kpi--content"
        [class.ngm-kpi__intent]="intent?.semanticObject"
        (click)="onIntentClick()"
      >
        <ng-container *ngTemplateOutlet="kpi; context: {kpiValue: kpiValue, options: options}"></ng-container>
      </div>
    }
    
    @if (trend$ | async; as trend) {
      <div class="ngm-kpi--trend flex justify-around items-end">
        <div class="ngm-kpi--reference">
          <div class="ngm-kpi--title" [ngStyle]="titleStyles$()">
            {{options?.targetText}}
          </div>
          <ngm-object-number
            [number]="trend.referenceValue"
            [unit]="trend.referenceValueUnit"
            [digitsInfo]="options?.digitsInfo"
            [shortNumber]="options?.shortNumber"
            [locale]="locale">
          </ngm-object-number>
        </div>

        @if (options?.showDeviation) {
          <div class="ngm-kpi--reference ngm-kpi--deviation">
            <div class="ngm-kpi--title">
              {{options?.deviationText || ('NX.SMART_KPI.DEVIATION_TEXT' | translate)}}
            </div>
            <ngm-object-number
              [number]="trend.deviation"
              unit="%"
              [digitsInfo]="options?.digitsInfo"
              [shortNumber]="false"
              [locale]="locale">
            </ngm-object-number>
          </div>
        }
        <ng-content select=".ngm-kpi--refs"></ng-content>
      </div>
    }

    @if (isLoading()) {
      <mat-spinner class="ngm-kpi--loading"
        [diameter]="18"
        [strokeWidth]="1"
      ></mat-spinner>
    }
    
  </div>

  @if (additionalDataPoints$ | async; as additionals) {
    <div class="ngm-kpi--additional">
      @for (kpiValue of additionals; track $index) {
        <ng-container *ngTemplateOutlet="kpi; context: {kpiValue: kpiValue, options: options?.additionalDataPoint || options}"></ng-container>
      }
    </div>
  }
</div>

<ng-template #kpi let-kpiValue="kpiValue" let-options="options">
  <div class="ngm-kpi--data-point" [ngClass]="{
    'trend-strong-up': kpiValue.arrow === TrendType.StrongUp,
    'trend-up': kpiValue.arrow === TrendType.Up,
    'trend-sideways': kpiValue.arrow === TrendType.Sideways,
    'trend-down': kpiValue.arrow === TrendType.Down,
    'trend-strong-down': kpiValue.arrow === TrendType.StrongDown
  }">
    <span class="ngm-kpi--title" [ngStyle]="titleStyles$()">{{kpiValue?.Title || options?.valueText}}</span>
    <div class="ngm-kpi--indicator flex" [ngStyle]="valueStyles()">
      @if (kpiValue.arrow) {
        <div class="ngm-kpi--arrow flex justify-center items-end">
          @switch (kpiValue.arrow) {
            @case (TrendType.StrongUp) {
              <mat-icon>north</mat-icon>
            }
            @case (TrendType.Up) {
              <mat-icon>north_east</mat-icon>
            }
            @case (TrendType.Down) {
              <mat-icon>south_east</mat-icon>
            }
            @case (TrendType.StrongDown) {
              <mat-icon>south</mat-icon>
            }
            @default {
              <mat-icon>remove</mat-icon>
            }
          }
        </div>
      }

      <div class="flex flex-col justify-start items-stretch">
        @if (options?.showDeviation) {
          <div class="ngm-kpi--reference ngm-kpi--deviation">
            @if (options?.deviationText) {
              <div class="ngm-kpi--title">
                {{options?.deviationText}}
              </div>
            }
            <ngm-object-number [number]="kpiValue.deviation" unit="%"
              [digitsInfo]="options?.digitsInfo"
              [shortNumber]="false"
              [locale]="locale">
            </ngm-object-number>
          </div>
        }

        <ngm-object-number class="ngm-kpi--value"
          [number]="kpiValue.value"
          [unit]="options?.unit || kpiValue.unit"
          [digitsInfo]="options?.digitsInfo"
          [shortNumber]="options?.shortNumber"
          [unitSemantics]="options?.unitSemantics || kpiValue.unitSemantics"
          [locale]="locale"
          (click)="onClick($event)">
        </ngm-object-number>

      </div>

    </div>
    
  </div>
</ng-template>

@if (error$ | async; as error) {
  <div class="pac-kpi-card__error ngm-card-error absolute left-0 top-0 w-full h-full overflow-auto 
    flex flex-col justify-center items-center backdrop-blur-md bg-white/10"
  >
    <span class="text-2xl font-notoColorEmoji">üêû</span>
    <div class="whitespace-pre-wrap max-w-full">
      {{ error }}
    </div>
  </div>
}

@if (editable && (placeholder$ | async)) {
  <div class="absolute top-0 left-0 w-full h-full flex flex-col justify-center items-center">
    <pac-kpi-placeholder class="cursor-pointer" (click)="openDesigner()"></pac-kpi-placeholder>
    <span>{{ 'Story.Widgets.KPI.Title' | translate: {Default: 'KPI'} }}</span>
  </div>
}