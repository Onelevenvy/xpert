<div class="relative w-full h-64 shrink-0 flex justify-start items-stretch p-1" ngmResizer [resizerHeight]="230">
    <div class="flex flex-col justify-start">
        <button mat-button (click)="back()">{{ 'PAC.KEY_WORDS.Back' | translate: {Default: 'Back'} }}</button>
    </div>

    <div class="flex-1 h-full flex justify-start items-stretch gap-2 p-1 overflow-auto">

        <div class="shrink-0 w-64 h-full flex flex-col justify-start items-stretch bg-white rounded-xl overflow-hidden">
            <div class="shrink-0 px-1 flex flex-wrap items-center">
                {{ 'PAC.KEY_WORDS.Measures' | translate: {Default: 'Measures'} }}
            </div>

            <div class="flex-1 overflow-auto" displayDensity="compact">
                <mat-selection-list id="ngm-story-explorer__drop-list-measures" class="w-full"
                    [ngModel]="measures()"
                    (ngModelChange)="onMeasuresChange($event)"
                    cdkDropList
                    [cdkDropListData]="[]">
                    <mat-list-option *ngFor="let item of measureList()" [value]="item"
                        cdkDrag
                        [cdkDragData]="item"
                    >
                      {{item.caption}}
                    </mat-list-option>
                </mat-selection-list>
            </div>
        </div>

        <div class="h-full flex gap-2" id="ngm-story-explorer__drop-list-dimensions-container"
            cdkDropList cdkDropListOrientation="horizontal"
            [cdkDropListData]="dimensions()"
            (cdkDropListDropped)="moveDimension($event)">
            <div *ngFor="let dim of dimensions(); trackBy: trackByDim" class="shrink-0 w-64 h-full flex flex-col justify-start items-stretch bg-white rounded-xl overflow-hidden"
                cdkDrag
                [cdkDragData]="dim"
            >
                <div class="shrink-0 px-1 flex flex-wrap items-center"
                    id="ngm-story-explorer__drop-list-dimensions"
                    cdkDropList
                    [cdkDropListData]="[]"
                >
                <div *ngFor="let item of dim.hierarchies" class="tag text-sm block font-bold leading-sm px-2 py-1 rounded-lg cursor-pointer
                    overflow-hidden text-ellipsis whitespace-nowrap"
                    [class.selected]="item.hierarchy === dim.dimension.hierarchy"
                    (click)="toggleHierarchy(item.hierarchy, dim)"
                    cdkDrag
                    [cdkDragData]="item"
                    >
                    <span>
                        {{item.caption}}
                    </span>
                </div>
                </div>
                <ngm-member-tree class="flex-1 overflow-auto" displayDensity="compact"
                    [dataSettings]="data.dataSettings"
                    [dimension]="dim.dimension"
                    [options]="{
                        searchable: true,
                        multiple: true,
                        selectionType: FilterSelectionType.Multiple
                    }"
                    [ngModel]="slicers[dim.dimension.dimension]"
                    (ngModelChange)="onSlicersChange($event, dim.dimension.dimension)"
                ></ngm-member-tree>
            </div>
        </div>

        <div class="w-96 h-full shrink-0 flex justify-start items-center rounded-xl cursor-pointer hover:bg-white" (click)="openDimensions()">
            <div>
                <svg width="100" height="100">
                    <circle cx="50" cy="50" r="40" class="fill-bluegray-100 group-hover:fill-bluegray-200 group-focus:fill-bluegray-200"/>
                    <rect x="25" y="48" width="50" height="4" fill="white"/>
                    <rect x="48" y="25" width="4" height="50" fill="white"/>
                </svg>
            </div>
            <div class="flex flex-col justify-center items-start">
                <div>Show Dimensions</div>
                <div>Bring in more dimensions from your dataset and start exploring.</div>
            </div>
        </div>
    </div>

    <div ngmResizerBar resizerBarPosition="bottom"
        cdkDrag
        cdkDragLockAxis="y"
    ></div>
</div>

<div class="w-full flex-1 flex justify-start items-stretch gap-2 overflow-hidden">
    <div ngmResizer [resizerWidth]="280" class="w-80 relative">
        <div ngmResizerBar resizerBarPosition="right"
            cdkDrag
            cdkDragLockAxis="x"
        ></div>
    
        <div *ngIf="visualPanel === 'options'" class="h-full bg-white rounded-xl flex flex-col justify-start items-stretch overflow-hidden" >
            <div class="font-bold px-2 py-1">{{ 'PAC.KEY_WORDS.Dimensions' | translate: {Default: 'Dimensions'} }}</div>
            <div class="pac-cdk-drop__list min-h-28 w-full flex flex-col justify-start items-stretch overflow-auto gap-1 p-2"
                id="ngm-story-explorer__drop-list-rows"
                cdkDropList
                [cdkDropListData]="rows()"
                (cdkDropListDropped)="dropRow($event)"
                [cdkDropListEnterPredicate]="dropRowPredicate">
                <ngm-property-select *ngFor="let row of rows(); index as i; trackBy: trackByIndex" class="w-full" editable displayDensity="compact"
                    showAttributes
                    [dataSettings]="dataSettings()"
                    [entityType]="entityType()"
                    [ngModel]="row"
                    [capacities]="[
                        PropertyCapacity.Dimension
                    ]"
                    cdkDrag
                    [cdkDragData]="row"
                    (ngModelChange)="onRowChange($event, i)"
                    >
                    <button displayDensity="compact" ngmAppearance="danger" mat-icon-button color="warn"
                        (click)="$event.stopPropagation();$event.preventDefault();removeRow(i)">
                        <mat-icon>clear</mat-icon>
                    </button>
                </ngm-property-select>
            </div>

            <div class="font-bold px-2 py-1">{{ 'PAC.KEY_WORDS.Measures' | translate: {Default: 'Measures'} }}</div>
            <div class="pac-cdk-drop__list min-h-28 w-full flex flex-col justify-start items-stretch overflow-auto gap-1 p-2"
                id="ngm-story-explorer__drop-list-columns"
                cdkDropList
                [cdkDropListData]="columns()"
                (cdkDropListDropped)="dropColumn($event)"
                [cdkDropListEnterPredicate]="dropColumnPredicate">
                <ngm-property-select *ngFor="let item of columns(); index as i; trackBy: trackByIndex" class="w-full" editable displayDensity="compact"
                    showAttributes
                    [dataSettings]="dataSettings()"
                    [entityType]="entityType()"
                    [ngModel]="item"
                    [capacities]="[
                        PropertyCapacity.Measure
                    ]"
                    cdkDrag
                    [cdkDragData]="item"
                    (ngModelChange)="onColumnChange($event, i)"
                    >
                    <button displayDensity="compact" ngmAppearance="danger" mat-icon-button color="warn"
                        (click)="$event.stopPropagation();$event.preventDefault();removeColumn(i)">
                        <mat-icon>clear</mat-icon>
                    </button>
                </ngm-property-select>
            </div>
        </div>

        <div *ngIf="visualPanel === 'visual'" class="h-full bg-white rounded-xl flex flex-col justify-start items-stretch overflow-auto">
            <div *ngFor="let group of charts" >
                <div class="text-sm p-2">
                    {{'FORMLY.CHART.' + group.label | translate: {Default: group.label} }}
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <button *ngFor="let chart of group.charts" class="ngm-story-explorer__chart m-2 flex flex-col justify-center items-center rounded-lg overflow-hidden
                        ring-offset-2 ring-2 ring-transparent hover:ring-violet-300 focus:ring-violet-500"
                        [matTooltip]="'FORMLY.CHART.' + chart.label | translate: {Default: chart.label}"
                        matTooltipPosition="above"
                        draggable="true"
                        [class.selected]="component().label === chart.label"
                        (click)="createWidget({
                            label: chart.label,
                            component: ComponentType.AnalyticalCard,
                            dataSettings: {
                                chartAnnotation: chart.value
                            }
                        })"
                    >
                        <img [src]="'/assets/icons/charts/' + chart.icon" class="w-12 h-12" alt="{{chart.label}}"
                            [ngStyle]="{
                                transform: chart.rotate ? 'rotate(90deg)' : 'none'
                            }"
                        >
                        <div class="text-xs">{{ 'FORMLY.CHART.' + chart.label | translate: {Default: chart.label} }}</div>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="flex-1 bg-white rounded-xl flex flex-col justify-center items-center overflow-hidden">
        <div class="flex-1 w-full overflow-hidden">
            <ngm-analytical-card *ngIf="view === 'chart'" class="w-full h-full group"
                [title]="'Data chart for dimensions and measure'"
                [dataSettings]="dataSettingsChart()"
                [slicers]="_slicers()"
                [chartOptions]="chartOptions()"
                >
            </ngm-analytical-card>

            <ngm-analytical-grid *ngIf="view === 'table'" class="w-full h-full group overflow-auto"
                [title]="'Data grid for dimensions and measure'"
                [dataSettings]="dataSettingsGrid()"
                [slicers]="_slicers()"
                [appearance]="{
                    displayDensity: DisplayDensity.compact
                }"
                [options]="{
                    showToolbar: true,
                    paging: true,
                    pageSize: 20,
                    sticky: true,
                    sortable: true
                }"
            ></ngm-analytical-grid>
        </div>
        <mat-divider class="w-full"></mat-divider>
        <div class="w-full flex justify-between items-center px-2">
            <mat-button-toggle-group class="ngm-button-group" displayDensity="cosy" ngmAppearance="color" color="accent"
                [(ngModel)]="visualPanel"
            >
                <mat-button-toggle value="visual">Visual</mat-button-toggle>
                <mat-button-toggle value="options">Options</mat-button-toggle>
            </mat-button-toggle-group>

            <mat-button-toggle-group class="ngm-button-group" displayDensity="cosy" ngmAppearance="color" color="accent"
                [(ngModel)]="view"
            >
                <mat-button-toggle value="table">Table</mat-button-toggle>
                <mat-button-toggle value="chart">Chart</mat-button-toggle>
            </mat-button-toggle-group>

            <div ngmButtonGroup >
                <button mat-raised-button color="primary">确定</button>
            </div>
        </div>
    </div>
</div>

<!-- <div class="flex-1 flex justify-center items-center p-2 gap-2 overflow-hidden">
    <div class="h-full flex-1 flex flex-col justify-start items-stretch gap-2 overflow-hidden">
    </div>
</div> -->

<ng-template #addDimensionsTempl>
    <div class="flex flex-col">
      <header mat-dialog-title cdkDrag cdkDragRootElement=".cdk-overlay-pane" cdkDragHandle>
        <h4 style="pointer-events: none;" class="mb-0">
          {{ 'Story.Explorer.AddDimensions' | translate: { Default: 'Add dimensions' } }}
        </h4>
      </header>
    
      <div mat-dialog-content class="mat-dialog-content mat-typography w-96">
        <mat-selection-list [ngModel]="_dimensionsCache()" (ngModelChange)="addDimensionToCache($event)"
            cdkDropList
            [cdkDropListData]="[]"
            (cdkDropListDropped)="moveDimension($event)">
            <mat-list-option *ngFor="let property of dimensionList()" [value]="property.name"
                cdkDrag
                [cdkDragData]="property">
              {{property.caption}}
            </mat-list-option>
        </mat-selection-list>
      </div>
    
      <mat-dialog-actions align="end">
        <div ngmButtonGroup>
          <button mat-button mat-dialog-close>
            {{ 'Story.Common.Cancel' | translate: { Default: 'Cancel' } }}
          </button>
    
          <button
            mat-raised-button
            color="accent"
            (click)="addDimensions()"
          >
            {{ 'Story.Common.Confirm' | translate: { Default: 'Confirm' } }}
          </button>
        </div>
      </mat-dialog-actions>
    </div>
</ng-template>
