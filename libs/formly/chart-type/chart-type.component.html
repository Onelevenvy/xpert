<label class="p-1 text-sm text-ellipsis whitespace-nowrap overflow-hidden">{{'FORMLY.CHART.ChartType' | translate: {Default: 'Chart Type'} }}</label>
<div class="flex flex-col py-1 px-2 rounded-md bg-gray-100 ring-offset-1 ring-2 ring-transparent hover:ring-yellow-500/50">
  <div class="flex items-center w-full max-w-full text-xs">
    <div class="pac-formly-chart-type__prefix">
      <ng-content class="ngm-prefix"></ng-content>
    </div>
  
    <mat-select class="flex-1" [formControl]="chartTypeControl" panelClass="ngm-formly-chart-type__panel ngm-select-panel ngm-density__cosy">
      <mat-select-trigger *ngIf="type" class="flex items-center">
        <mat-icon *ngIf="type" class="mr-1" displayDensity="compact" [svgIcon]="getChartType(type)?.icon"></mat-icon>
        <div class="flex-1">
          <span>{{ 'FORMLY.CHART.' + typeLabel | translate: {Default: typeLabel} }}</span>
          <span *ngIf="name.value" class="">:{{name.value}}</span>
        </div>

        <button *ngIf="type!==NxChartType.Custom" matSuffix mat-icon-button displayDensity="compact"
          (click)="$event.stopPropagation();$event.preventDefault();showMore.set(!showMore())">
          <mat-icon *ngIf="!showMore()">expand_more</mat-icon>
          <mat-icon *ngIf="showMore()">expand_less</mat-icon>
        </button>
  
        <button *ngIf="type===NxChartType.Custom" matSuffix mat-icon-button displayDensity="compact"
          (click)="$event.stopPropagation();$event.preventDefault();showCustomCode.set(!showCustomCode())">
          <mat-icon fontSet="material-icons-outlined"
            [color]="showCustomCode()?'accent':''"
          >code</mat-icon>
        </button>

      </mat-select-trigger>
      
      <mat-option>-- {{'FORMLY.CHART.None' | translate: {Default: 'None'} }} --</mat-option>
      <mat-optgroup *ngFor="let group of chartTypeGroups" [label]=" 'FORMLY.CHART.' + group.name | translate: {Default: group.name} "
                    [disabled]="group.disabled">
        <mat-option *ngFor="let chart of group.charts" [value]="chart.value" class="text-slate-500">
          <mat-icon [svgIcon]="chart.icon" ></mat-icon>
          {{ 'FORMLY.CHART.' + chart.label | translate: {Default: chart.label} }}
        </mat-option>
      </mat-optgroup>
    </mat-select>

    <button matSuffix *ngIf="removable" class="ngm-formly__remove" displayDensity="compact"
      mat-icon-button color="warn"
      (click)="$event.stopPropagation();$event.preventDefault();killMyself()">
      <mat-icon>clear</mat-icon>
    </button>
  </div>

  <div *ngIf="showMore()" class="min-h-12 w-full flex flex-col justify-start items-stretch gap-2 mt-2">

    <div class="flex flex-col justify-start items-start gap-2 rounded-lg p-2 bg-white" displayDensity="compact">
      <div class="flex items-center text-sm">
        <mat-icon fontSet="material-icons-outlined" displayDensity="compact" class="text-slate-900">edit_attributes</mat-icon>
        <span>{{ 'FORMLY.CHART.ChartType' | translate: {Default: 'Chart Type'} }}</span>
      </div>

      <ngm-input class="w-full" [label]="'FORMLY.CHART.ChartName' | translate: {Default: 'Chart Name'}"
        [formControl]="name"
      ></ngm-input>
      
      <div *ngIf="HAS_ORIENTS[type]" class="flex flex-col justify-start items-start">
        <label class="ngm-input-label">{{ 'FORMLY.CHART.Orient' | translate: {Default: 'Orient'} }}</label>
        <mat-radio-group [(ngModel)]="orient">
          <mat-radio-button *ngFor="let orient of ORIENTS" [value]="orient.value">
            {{'FORMLY.CHART.'+orient.label | translate: {Default: orient.label} }}
          </mat-radio-button>
        </mat-radio-group>
      </div>

      <div *ngIf="VARIANTS[type]" class="flex flex-col justify-start items-start">
        <label class="ngm-input-label">{{ 'FORMLY.CHART.Variant' | translate: {Default: 'Variant'} }}</label>
        <mat-radio-group [(ngModel)]="variant">
          <mat-radio-button *ngFor="let option of VARIANTS[type]" [value]="option.value">
            {{ 'FORMLY.CHART.'+option.label | translate: {Default: option.label} }}
          </mat-radio-button>
        </mat-radio-group>
      </div>
    </div>

    <form *ngIf="type===NxChartType.GeoMap" [formGroup]="mapFormGroup" class="flex flex-col justify-start items-start gap-2 rounded-lg p-2 bg-white"
      displayDensity="compact">
      <div class="flex items-center text-sm">
        <mat-icon fontSet="material-icons-outlined" displayDensity="compact" class="text-slate-900">map</mat-icon>
        <span>{{ 'FORMLY.CHART.GeoMapConfig' | translate: {Default: 'GeoMap Config'} }}</span>
      </div>

      <ngm-input class="self-stretch" [label]="'FORMLY.CHART.MapName' | translate: {Default: 'Map Name'}" formControlName="map"></ngm-input>
      
      <ngm-input class="self-stretch" [label]="'FORMLY.CHART.MapUrl' | translate: {Default: 'Map Url'}" formControlName="mapUrl"></ngm-input>
      
      <mat-checkbox formControlName="isTopoJSON">
        {{ 'FORMLY.CHART.IsTopoJSON' | translate: {Default: 'Is TopoJSON'} }}
      </mat-checkbox>
      
      <ngm-input *ngIf="mapFormGroup.value.isTopoJSON" class="self-stretch"
        [label]="'FORMLY.CHART.FeatureObjectNames' | translate: {Default: 'Feature Object Names'}"
        formControlName="features"></ngm-input>

      <ngm-select [label]="'FORMLY.CHART.MapProjection' | translate: {Default: 'Map Projection'}"
        formControlName="projection"
        valueKey="key"
        [selectOptions]="GeoProjections"
        >
      </ngm-select>

      <div ngmButtonGroup class="self-end">
        <button mat-flat-button [disabled]="mapFormGroup.pristine" (click)="confirmMap()">
          {{ 'FORMLY.COMMON.Reset' | translate: {Default: 'Reset'} }}
        </button>
        <button mat-raised-button color="primary" [disabled]="mapFormGroup.invalid || mapFormGroup.pristine" (click)="confirmMap(true)">
          {{ 'FORMLY.COMMON.Apply' | translate: {Default: 'Apply'} }}
        </button>
      </div>
    </form>

    <div class="w-full bg-white rounded-lg">
      <div class="flex items-center text-sm p-2">
        <mat-icon fontSet="material-icons-outlined" displayDensity="compact" class="text-slate-900">analytics</mat-icon>
        <span>{{ 'FORMLY.CHART.ChartOptions' | translate: {Default: 'Chart Options'} }}</span>
      </div>

      <ngm-designer-form class="w-full" [(ngModel)]="chartOptions"></ngm-designer-form>
    </div>
    
  </div>

  <div *ngIf="showCustomCode()" class="flex flex-col justify-start items-stretch relative mt-2 bg-white rounded-lg overflow-hidden"
    ngmResizer [resizerHeight]="500">
    <header class="flex justify-between items-center px-2">
      <input matInput class="rounded-md p-1 outline-none text-sm bg-white focus-within:bg-slate-100 hover:bg-slate-200" [formControl]="name"
        placeholder="{{ 'FORMLY.CHART.CustomCode' | translate: {Default: 'Custom Code'} }}"  
      />
    
      <div class="flex items-center gap-2">
        <button mat-icon-button displayDensity="compact" [disabled]="!scripts || answering"
          [matTooltip]=" 'FORMLY.CHART.AutomaticallyGenerateCode' | translate: {Default: 'Automatically generate code by comments'} "
          (click)="askComplete()">
            <mat-icon fontSet="material-icons-outlined">auto_awesome</mat-icon>
        </button>
        <button mat-icon-button displayDensity="compact" [disabled]="answering"
            [popper]="copilot"
            [popperTrigger]="NgxPopperjsTriggers.click"
            [popperHideOnClickOutside]="true"
            [popperHideOnScroll]="true"
            [popperHideOnMouseLeave]="false"
            [popperPlacement]="NgxPopperjsPlacements.TOPEND">
            <mat-icon fontSet="material-icons-outlined">try</mat-icon>
        </button>
      </div>
    </header>
    
    <ngx-monaco-editor class="flex-1 w-full"
        [options]="editorOptions"
        [(ngModel)]="scripts"
        (onInit)="editor$.next($event)"
    ></ngx-monaco-editor>
    <div ngmResizerBar resizerBarPosition="bottom" style="z-index: 1;"
      cdkDrag
      cdkDragLockAxis="y"
    ></div>
  </div>

</div>


<popper-content #copilot class="z-[101]">
  <form (ngSubmit)="copilot.hide();askCopilot()" class="bg-white p-1">
    <div class="relative w-full flex ">
      <div class="absolute inset-y-0 left-1 flex items-center pointer-events-none font-notoColorEmoji">
        ðŸ¤–
      </div>
      <input type="text" id="simple-search" class="block w-full pl-6 p-1 outline-none text-sm rounded-lg bg-gray-50 border border-gray-300 text-gray-900 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
        placeholder="{{ 'FORMLY.CHART.Ask' | translate: {Default: 'Ask'} }}..." required
        matInput [(ngModel)]="prompt" [ngModelOptions]="{standalone: true}"
      >
    </div>
  </form>
</popper-content>
