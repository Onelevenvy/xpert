<label class="flex item p-1 text-sm text-ellipsis whitespace-nowrap overflow-hidden">
  @if (label()) {
    <span class="mr-1">{{label()}}</span>
  }
  @if (label$ | async; as label) {
    @if (label.icon) {
      <mat-icon displayDensity="compact">{{ label.icon }}</mat-icon>
    }
    <span>
      {{ 'Ngm.Property.'+(label?.label ?? 'DIMENSION_MEASURE') | translate: {Default: label?.label ?? 'Dimension/Measure'} }}
    </span>
  }
</label>

<div class="select-container flex flex-col items-stretch gap-2 w-full max-w-full p-1 text-xs rounded-lg 
  ring-offset-1 ring-offset-transparent ring-2 ring-transparent hover:ring-yellow-500/50">
  <form [formGroup]="formGroup" class="relative flex-1 max-w-full flex justify-start items-center">
    <div class="flex items-center">
      <ng-content select="[ngmPrefix]"></ng-content>
    </div>
    <mat-select #propertySelect [formControl]="keyControl" class="overflow-hidden flex-1"
      panelClass="ngm-property-select__panel ngm-select-panel ngm-density__cosy" 
      [required]="required()">
      @if (selectTrigger()) {
        <mat-select-trigger class="flex items-center overflow-hidden pl-2">
          <ngm-entity-property hiddenIcon [property]="selectTrigger()" class="flex-1" />

          <div class="flex items-center" displayDensity="compact">

            <button matSuffix mat-icon-button (click)="$event.stopPropagation();$event.preventDefault();showMore.set(!showMore())">
              @if (showMore()) {
                <mat-icon>expand_less</mat-icon>
              } @else {
                <mat-icon>expand_more</mat-icon>
              }
            </button>
            @if (showAttributes()) {
              <button mat-icon-button [displayDensity]="displayDensity()"
                [matMenuTriggerFor]="dimensionMenu"
                #mt="matMenuTrigger"
                [class.active]="mt.menuOpen"
                (click)="$event.stopPropagation();$event.preventDefault();">
                  <mat-icon>more_vert</mat-icon>
              </button>
            }
            @if (hierarchies$ | async) {
              <button mat-icon-button [displayDensity]="displayDensity()"
                [cdkMenuTriggerFor]="hierarchyMenu"
                #mt="cdkMenuTriggerFor"
                [class.active]="mt.isOpen()"
                (click)="$event.stopPropagation();$event.preventDefault();">
                  <mat-icon fontSet="material-icons-outlined">account_tree</mat-icon>
              </button>
            }
            @if (membersSignal()) {
              <button mat-icon-button [displayDensity]="displayDensity()"
                [matMenuTriggerFor]="membersMenu"
                #mt="matMenuTrigger"
                [class.active]="mt.menuOpen"
                (click)="$event.stopPropagation();$event.preventDefault();">
                  <mat-icon>straighten</mat-icon>
              </button>
            }
          </div>
        </mat-select-trigger>
      }

      <ngm-search class="w-full px-1" displayDensity="cosy" [formControl]="searchControl"
        (keydown)="onSearchKeydown($event)"
        (click)="$event.stopPropagation()"/>

    @if (showDimension()) {
      <mat-optgroup [label]=" 'Ngm.Property.DIMENSIONS' | translate: {Default: 'Dimensions'} ">
        @for (property of dimensions$ | async; track property.name) {
          <mat-option class="" [value]="property.name"
            [ngClass]="{
              'ngm-option__dimension': property.role === AggregationRole.dimension,
              'ngm-option__hierarchy': property.role === AggregationRole.hierarchy,
              'ngm-option__level': property.role === AggregationRole.level,
              'ngm-option__hidden': property.visible === false
            }"
          >
            <ngm-entity-property class="flex-1" [property]="property" [displayBehaviour]="DISPLAY_BEHAVIOUR.auto" [displayDensity]="DisplayDensity.cosy" [highlight]="search" />
          </mat-option>
        }
      </mat-optgroup>
    }

    @if (showMeasure()) {
      <mat-optgroup [label]=" 'Ngm.Property.CALCULATIONS' | translate: {Default: 'Calculations'} ">
        @for (property of calculations(); track property.name) {
          <mat-option class="ngm-option__measure" [value]="property.name">
            <ngm-entity-property class="flex-1" [property]="property" [displayBehaviour]="DISPLAY_BEHAVIOUR.auto" [highlight]="search" />
          </mat-option>
        }
        @if (editable()) {
          <mat-option class="ngm-property-select__action mt-2" [value]="null"
            (click)="$event.stopPropagation();$event.preventDefault();">
            <button mat-button color="primary" ngmAppearance="dashed" class="ngm-property-select__create-calculation w-full"
              (click)="$event.stopPropagation();onCreateCalculation($event)">
              <div class="flex justify-center items-center whitespace-nowrap text-ellipsis overflow-hidden">
                <mat-icon>add</mat-icon>
                <span>{{ 'Ngm.Property.CREATE_CALCULATION' | translate: {Default: 'Create Calculation'} }}</span>
              </div>
            </button>
          </mat-option>
        }
      </mat-optgroup>
    }
    @if (showMeasureControl()) {
      <mat-optgroup [label]=" 'Ngm.Property.MEASURE_CONTROLS' | translate: {Default: 'Measure Controls'} ">
        @for (property of measureControls(); track property.name) {
          <mat-option [value]="property.name">
            <ngm-entity-property class="flex-1" [property]="property" [displayBehaviour]="DISPLAY_BEHAVIOUR.auto" [highlight]="search" />
          </mat-option>
        }

        @if (editable()) {
          <mat-option class="mt-2">
            <button mat-button class="flex-1" color="primary" ngmAppearance="dashed" (click)="onCreateCalculation($event, CalculationType.MeasureControl)">
              <mat-icon>add</mat-icon>
              {{ 'Ngm.Property.CREATE_MEASURE_CONTROL' | translate: {Default: 'Create Measure Control'} }}
            </button>
          </mat-option>
        }
      </mat-optgroup>
    }
    
    @if (showMeasure()) {
      <mat-optgroup [label]=" 'Ngm.Property.MEASURES' | translate: {Default: 'Measures'} ">
        @for (property of notCalculations$ | async; track property.name) {
          <mat-option class="ngm-option__measure" [value]="property.name">
            <ngm-entity-property class="flex-1" [property]="property" [displayBehaviour]="DISPLAY_BEHAVIOUR.auto" [highlight]="search" />
          </mat-option>
        }
      </mat-optgroup>
    }
    @if (showParameter()) {
      <mat-optgroup [label]=" 'Ngm.Property.PARAMETERS' | translate: {Default: 'Parameters'} ">
        @for (property of parameters$ | async; track property.name) {
          <mat-option [value]="property.name">
            <ngm-entity-property class="flex-1" [property]="property" [displayBehaviour]="DISPLAY_BEHAVIOUR.auto" [highlight]="search" />
          </mat-option>
        }
      </mat-optgroup>
    }
    
    @if (showMeasure()) {
      <mat-optgroup [label]=" 'Ngm.Property.INDICATORS' | translate: {Default: 'Indicators'} ">
        @for (property of indicators$ | async; track property.name) {
          <mat-option class="ngm-option__measure" [value]="property.name">
            <ngm-entity-property class="flex-1" [property]="property" [displayBehaviour]="DISPLAY_BEHAVIOUR.auto" [highlight]="search" />
          </mat-option>
        }
      </mat-optgroup>
    }
    </mat-select>
    
    <div class="absolute left-0 top-0 h-full max-w-full flex items-center overflow-hidden pointer-events-none">
      @if (entityTypeLoading()) {
        <mat-spinner
          [diameter]="20"
          [strokeWidth]="1"
        />
      }

      @if (error()) {
        <div class="mat-error overflow-hidden text-ellipsis whitespace-nowrap">{{error()}}</div>
      }
    </div>

    <ng-content select="[ngmSuffix]"></ng-content>
  </form>
  @if (showMore()) {
    <div class="min-h-12 w-full flex justify-center items-center">
      <ng-content></ng-content>
    </div>
  }
</div>

<mat-menu #dimensionMenu="matMenu" class="ngm-formly ngm-density__compact">
  @if (showDisplayAs()) {
    <button mat-menu-item disableRipple [matMenuTriggerFor]="displayMenu">
      <mat-icon class="shrink-0">dvr</mat-icon>
      <span>{{ 'Ngm.Property.DisplayAs' | translate: {Default: "Display As"} }}...</span>
    </button>
  }

  @if (labels$ | async; as labels) {
    <button mat-menu-item disableRipple [matMenuTriggerFor]="labelMenu">
      <mat-icon class="shrink-0" fontSet="material-icons-outlined">label</mat-icon>
      <span>{{ 'Ngm.Property.Label' | translate: {Default: "Label"} }}</span>
    </button>
  }

  <button mat-menu-item (click)="$event.stopPropagation();$event.preventDefault();">
    <ngm-input class="w-full flex-row" style="flex-direction: row; align-items: center;"
      label="{{ 'Ngm.Property.Caption' | translate: {Default: 'Caption'} }}"
      [(ngModel)]="caption"
      (keydown.space)="$event.stopPropagation();$event.preventDefault();"
    ></ngm-input>
  </button>

  @if (isMeasure$ | async) {
    @if (showMeasureAttributes()) {
      <button mat-menu-item (click)="openFormatting($event)">
        <mat-icon class="shrink-0">monetization_on</mat-icon>
        <span>{{ 'Ngm.Property.Formatter' | translate: {Default: "Formatter"} }}</span>
      </button>
    }
  
    @if (calculationProperty(); as calculationProperty) {
      <button mat-menu-item
        (click)="$event.preventDefault();openEditCalculation(calculationProperty)">
          <mat-icon class="shrink-0">functions</mat-icon>
          <span fontSet="material-icons-outlined">
            {{ 'Ngm.Property.EditFormula' | translate: {Default: "Edit Formula"} }}
          </span>
      </button>
    }
  }

  @if (isParameter()) {
    <button mat-menu-item (click)="openEditParameter()">
      <mat-icon class="shrink-0" fontSet="material-icons-outlined">edit</mat-icon>
      <span>{{ 'Ngm.Property.PARAMETER' | translate: {Default: "Parameter"} }}</span>
    </button>
  }

  @if (isDimension()) {
    <button mat-menu-item disableRipple (click)="$event.stopPropagation();">
      <mat-checkbox [(ngModel)]="unbookedData">
        {{ 'Ngm.Property.UnbookedData' | translate: {Default: "Unbooked Data"} }}
      </mat-checkbox>
    </button>
  }
  @if (isDimension() || showMeasureAttributes()) {
    <button mat-menu-item disableRipple (click)="$event.stopPropagation();">
      <mat-checkbox [(ngModel)]="zeroSuppression">
        {{ 'Ngm.Property.ZeroSuppression' | translate: {Default: "Zero Suppression"} }}
      </mat-checkbox>
    </button>
  }

  @if (showOrder()) {
    <button mat-menu-item disableRipple [matMenuTriggerFor]="orderMenu">
      <mat-icon class="shrink-0" fontSet="material-icons-round">sort_by_alpha</mat-icon>
      <span>{{ 'Ngm.Property.Order' | translate: {Default: "Order"} }}</span>
    </button>
  }
  
</mat-menu>

<mat-radio-group [(ngModel)]="displayBehaviour">
  <mat-menu #displayMenu="matMenu" class="ngm-formly ngm-density__compact">
    <button mat-menu-item disableRipple *ngFor="let behaviour of DISPLAY_BEHAVIOUR_LIST"
      (click)="$event.stopPropagation();">
      <mat-radio-button [value]="behaviour.value">
        {{ 'Ngm.Property.' + behaviour.label | translate: {Default: behaviour.label} }}
      </mat-radio-button>
    </button>
  </mat-menu>
</mat-radio-group>

<mat-radio-group [(ngModel)]="memberCaption">
  <mat-menu #labelMenu="matMenu" class="ngm-formly ngm-density__compact">
    <button mat-menu-item disableRipple
      (click)="$event.stopPropagation();">
      <mat-radio-button class="ngm-radio-button__property" [value]="null">
        {{ 'Ngm.Property.Auto' | translate: {Default: "Auto"} }}
      </mat-radio-button>
    </button>

    @for (item of labels$ | async; track item.name) {
      <button mat-menu-item disableRipple
        (click)="$event.stopPropagation();">
        <mat-radio-button class="ngm-radio-button__property" [value]="item.name" [title]="item.caption">
          {{item.caption}}
        </mat-radio-button>
      </button>
    }
  </mat-menu>
</mat-radio-group>

<mat-radio-group [(ngModel)]="level">
  <ng-template #hierarchyMenu>
    <div cdkMenu class="cdk-menu__large">
      <button cdkMenuItem [cdkMenuTriggerFor]="hierarchiesMenu">
        <mat-icon class="shrink-0 mr-1" fontSet="material-icons-outlined">account_tree</mat-icon>
        <span>{{ 'Ngm.Property.HIERARCHY' | translate: {Default: "Hierarchy"} }}...</span>
      </button>
    
      <hr class="my-1" />

      <div cdkMenuGroup>
        <button class="w-full" cdkMenuItemRadio
          [cdkMenuItemChecked]="!level"
          (cdkMenuItemTriggered)="level = null">
          {{ 'Ngm.Property.Default' | translate: {Default: "Default"} }}
        </button>
        @for (property of levels$ | async; track property.name) {
          <button class="w-full" cdkMenuItemRadio
            [cdkMenuItemChecked]="level === property.name"
            (cdkMenuItemTriggered)="level = property.name">
            <ngm-entity-property class="w-full" hiddenIcon [property]="property" [displayBehaviour]="DISPLAY_BEHAVIOUR.auto" />
          </button>
        }
      </div>

      <hr class="my-1" />
    
      <button cdkMenuItem disableRipple (click)="selectMembers($event)">
        <mat-icon class="shrink-0 mr-1" fontSet="material-icons-outlined">people_outline</mat-icon>
        <span [matBadgeHidden]="!members?.length" [matBadge]="members?.length" matBadgeColor="accent" matBadgeOverlap="false"
          [class.line-through.decoration-pink-500]="exclude"
        >
          {{ 'Ngm.Property.MEMBERS' | translate: {Default: "Members"} }}
        </span>
      </button>

      <button cdkMenuItem [cdkMenuTriggerFor]="memberMenu">
        <mat-icon class="shrink-0 mr-1" fontSet="material-icons-outlined">alternate_email</mat-icon>
        <span [matBadge]="parameter ? 1 : null" matBadgeColor="accent" matBadgeOverlap="false">
          {{ 'Ngm.Property.PARAMETER' | translate: {Default: "Parameter"} }}
        </span>
      </button>
      @if (showAttributes()) {
        <button cdkMenuItem disableRipple [cdkMenuTriggerFor]="propertiesMenu">
          <mat-icon class="shrink-0 mr-1" fontSet="material-icons-outlined">extension</mat-icon>
          {{ 'Ngm.Property.PropertyList' | translate: {Default: "Property List"} }}
        </button>

        <button cdkMenuItem class="flex justify-start items-center" (click)="$event.stopPropagation();">
          <mat-checkbox
            [(ngModel)]="displayHierarchy" [ngModelOptions]="{standalone: true}" style="width: 100%;">
            {{ 'Ngm.Property.DisplayHierarchy' | translate: {Default: "Display as Hierarchy"} }}
          </mat-checkbox>
        </button>
      }
    </div>
  </ng-template>
</mat-radio-group>

<ng-template #hierarchiesMenu>
  <div cdkMenu class="cdk-menu__large">
    <div cdkMenuItemRadio
      [cdkMenuItemChecked]="!hierarchy"
      (cdkMenuItemTriggered)="hierarchy = null">
      {{ 'Ngm.Property.Default' | translate: {Default: "Default"} }}
    </div>
    @for (property of hierarchies$ | async; track property.name) {
      <div cdkMenuItemRadio 
        [cdkMenuItemChecked]="hierarchy === property.name"
        (cdkMenuItemTriggered)="hierarchy = property.name"
      >
        <ngm-entity-property class="w-full" hiddenIcon [property]="property" [displayBehaviour]="DISPLAY_BEHAVIOUR.auto" />
      </div>
    }
  </div>
</ng-template>

<mat-menu #membersMenu="matMenu" class="ngm-density__compact">
  @for (property of membersSignal(); track property.name) {
    <button mat-menu-item class="w-full" disableRipple
      (click)="$event.stopPropagation();">
      <mat-checkbox class="ngm-checkbox__property" [checked]="$any(property).selected" (change)="toggleMember(property.name, $event.checked)">
        <ngm-entity-property class="w-full" hiddenIcon [property]="property" [displayBehaviour]="DISPLAY_BEHAVIOUR.auto" />
      </mat-checkbox>
    </button>
  }
</mat-menu>

<ng-template #propertiesMenu>
  <div cdkMenu class="cdk-menu__large">
    <mat-selection-list [(ngModel)]="properties" [ngModelOptions]="{standalone: true}" displayDensity="compact">
      @for (property of properties$ | async; track property.name) {
        <mat-list-option [value]="property.name"
          (click)="$event.stopPropagation();">
          {{ property.caption }}
        </mat-list-option>
      } @empty {
        <div class="text-sm text-text-secondary">
          {{ 'Ngm.Property.NoProperties' | translate: {Default: "No Properties"} }}
        </div>
      }
    </mat-selection-list>
  </div>
</ng-template>

<ng-template #memberMenu >
  <div cdkMenu class="cdk-menu__large">
    <button class="w-full" cdkMenuItemRadio
      [cdkMenuItemChecked]="!parameter"
      (cdkMenuItemTriggered)="parameter = null">
      {{ 'Ngm.Common.None' | translate: {Default: "None"} }}
    </button>

    @for (option of parameters$ | async; track option.name) {
      <button class="w-full flex justify-between items-center"
        cdkMenuItemRadio
        [cdkMenuItemChecked]="parameter === option.name"
        (cdkMenuItemTriggered)="parameter = option.name">
        <span class="grow">{{ option.caption || option.name }}</span>
        <button mat-icon-button displayDensity="cosy" (click)="openEditParameter(option.name)">
          <mat-icon fontSet="material-icons-outlined">edit</mat-icon>
        </button>
      </button>
    }
  
    <hr class="my-1" />

    <button cdkMenuItem ngmAppearance="dashed" (click)="$event.stopPropagation();openCreateParameter()">
      <mat-icon class="shrink-0" fontSet="material-icons-outlined">add</mat-icon>
      <span>{{ 'Ngm.Property.CreateParameter' | translate: {Default: "Create Parameter"} }}</span>
    </button>
  </div>
</ng-template>

<mat-radio-group [(ngModel)]="order">
  <mat-menu #orderMenu="matMenu" class="ngm-density__compact">
    <button mat-menu-item disableRipple (click)="$event.stopPropagation();">
      <mat-radio-button class="ngm-radio-button__property" [value]="null">
        {{ 'Ngm.Property.None' | translate: {Default: "None"} }}
      </mat-radio-button>
    </button>

    <button mat-menu-item disableRipple (click)="$event.stopPropagation();">
      <mat-radio-button class="ngm-radio-button__property" value="ASC">
        {{ 'Ngm.Property.Order_ASC' | translate: {Default: "ASC"} }}
      </mat-radio-button>
    </button>
    <button mat-menu-item disableRipple (click)="$event.stopPropagation();">
      <mat-radio-button class="ngm-radio-button__property" value="DESC">
        {{ 'Ngm.Property.Order_DESC' | translate: {Default: "DESC"} }}
      </mat-radio-button>
    </button>
  </mat-menu>
</mat-radio-group>
