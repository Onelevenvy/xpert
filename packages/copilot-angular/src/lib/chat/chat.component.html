<div class="text-base font-semibold p-2 flex justify-between items-center">
  <div class="flex items-start gap-1">
    <span>{{ 'Copilot.Copilot' | translate: {Default: 'Copilot'} }}</span>

    @if (copilotEngine?.name) {
      <span>:</span><span>{{copilotEngine.name}}</span>
    }

    <span class="bg-yellow-100 text-yellow-800 text-xs font-medium me-2 px-2 py-0.5 rounded-full dark:bg-yellow-900 dark:text-yellow-300">Beta</span>
  </div>

  <span class="flex-1"></span>

  @if (role()) {
    <span class="cursor-pointer bg-purple-100 text-purple-800 text-sm font-medium me-2 px-2 py-0.5 rounded-xl dark:bg-purple-900 dark:text-purple-300"
      [matTooltip]="roleDetail()?.description"
      (click)="switchRole()">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="h-4 w-4 inline-block align-text-bottom"><path fill="currentColor" fill-rule="evenodd" d="M12 7.42a22 22 0 0 0-2.453 2.127A22 22 0 0 0 7.42 12a22 22 0 0 0 2.127 2.453c.807.808 1.636 1.52 2.453 2.128a22 22 0 0 0 2.453-2.128A22 22 0 0 0 16.58 12a22 22 0 0 0-2.127-2.453A22 22 0 0 0 12 7.42m1.751-1.154a25 25 0 0 1 2.104 1.88 25 25 0 0 1 1.88 2.103c.316-.55.576-1.085.779-1.59.35-.878.507-1.625.503-2.206-.003-.574-.16-.913-.358-1.111-.199-.199-.537-.356-1.112-.36-.58-.003-1.328.153-2.205.504-.506.203-1.04.464-1.59.78Zm3.983 7.485a25 25 0 0 1-1.88 2.104 25 25 0 0 1-2.103 1.88 13 13 0 0 0 1.59.779c.878.35 1.625.507 2.206.503.574-.003.913-.16 1.111-.358.199-.199.356-.538.36-1.112.003-.58-.154-1.328-.504-2.205a13 13 0 0 0-.78-1.59ZM12 18.99c.89.57 1.768 1.03 2.605 1.364 1.026.41 2.036.652 2.955.646.925-.006 1.828-.267 2.5-.94.673-.672.934-1.575.94-2.5.006-.919-.236-1.929-.646-2.954A15.7 15.7 0 0 0 18.99 12a15.6 15.6 0 0 0 1.364-2.606c.41-1.025.652-2.035.646-2.954-.006-.925-.267-1.828-.94-2.5-.672-.673-1.575-.934-2.5-.94-.919-.006-1.929.235-2.954.646-.838.335-1.716.795-2.606 1.364a15.7 15.7 0 0 0-2.606-1.364C8.37 3.236 7.36 2.994 6.44 3c-.925.006-1.828.267-2.5.94-.673.672-.934 1.575-.94 2.5-.006.919.235 1.929.646 2.955A15.7 15.7 0 0 0 5.01 12c-.57.89-1.03 1.768-1.364 2.605-.41 1.026-.652 2.036-.646 2.955.006.925.267 1.828.94 2.5.672.673 1.575.934 2.5.94.92.006 1.93-.235 2.955-.646A15.7 15.7 0 0 0 12 18.99m-1.751-1.255a25 25 0 0 1-2.104-1.88 25 25 0 0 1-1.88-2.104c-.315.55-.576 1.085-.779 1.59-.35.878-.507 1.625-.503 2.206.003.574.16.913.359 1.111.198.199.537.356 1.111.36.58.003 1.328-.153 2.205-.504.506-.203 1.04-.463 1.59-.78Zm-3.983-7.486a25 25 0 0 1 1.88-2.104 25 25 0 0 1 2.103-1.88 13 13 0 0 0-1.59-.779c-.878-.35-1.625-.507-2.206-.503-.574.003-.913.16-1.111.359-.199.198-.356.537-.36 1.111-.003.58.153 1.328.504 2.205.203.506.464 1.04.78 1.59Z" clip-rule="evenodd"></path></svg>
      {{roleDetail()?.title}}
    </span>
  }

  @if (conversations()) {
    <button class="p-1 rounded-lg hover:bg-black/5 dark:hover:bg-white/10" [matTooltip]="'Copilot.NewChat' | translate: {Default: 'New chat'}"
      (click)="newChat()">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 24 24" class="icon-xl-heavy"><path d="M15.673 3.913a3.121 3.121 0 1 1 4.414 4.414l-5.937 5.937a5 5 0 0 1-2.828 1.415l-2.18.31a1 1 0 0 1-1.132-1.13l.311-2.18A5 5 0 0 1 9.736 9.85zm3 1.414a1.12 1.12 0 0 0-1.586 0l-5.937 5.937a3 3 0 0 0-.849 1.697l-.123.86.86-.122a3 3 0 0 0 1.698-.849l5.937-5.937a1.12 1.12 0 0 0 0-1.586M11 4A1 1 0 0 1 10 5c-.998 0-1.702.008-2.253.06-.54.052-.862.141-1.109.267a3 3 0 0 0-1.311 1.311c-.134.263-.226.611-.276 1.216C5.001 8.471 5 9.264 5 10.4v3.2c0 1.137 0 1.929.051 2.546.05.605.142.953.276 1.216a3 3 0 0 0 1.311 1.311c.263.134.611.226 1.216.276.617.05 1.41.051 2.546.051h3.2c1.137 0 1.929 0 2.546-.051.605-.05.953-.142 1.216-.276a3 3 0 0 0 1.311-1.311c.126-.247.215-.569.266-1.108.053-.552.06-1.256.06-2.255a1 1 0 1 1 2 .002c0 .978-.006 1.78-.069 2.442-.064.673-.192 1.27-.475 1.827a5 5 0 0 1-2.185 2.185c-.592.302-1.232.428-1.961.487C15.6 21 14.727 21 13.643 21h-3.286c-1.084 0-1.958 0-2.666-.058-.728-.06-1.369-.185-1.96-.487a5 5 0 0 1-2.186-2.185c-.302-.592-.428-1.233-.487-1.961C3 15.6 3 14.727 3 13.643v-3.286c0-1.084 0-1.958.058-2.666.06-.729.185-1.369.487-1.961A5 5 0 0 1 5.73 3.545c.556-.284 1.154-.411 1.827-.475C8.22 3.007 9.021 3 10 3A1 1 0 0 1 11 4"></path></svg>
    </button>
  }
</div>

<div class="ngm-copilot-chat__content relative flex-1 flex flex-col overflow-hidden">
    <div #chatsContent class="flex-1 flex flex-col overflow-y-auto overflow-x-hidden">

      @for (conversation of (copilotEnabled() ? conversations() : _mockConversations); track $index; let last = $last) {
        @for (message of conversation.messages; track message.id) {
            @switch (message.role) {
              @case (CopilotChatMessageRoleEnum.Assistant) {
                <div class="pl-2 pr-4 flex">
                    <div class="flex-1 flex items-start overflow-auto">
                        <div class="relative flex flex-col items-center shrink-0">
                            @if (assistantAvatar) {
                                @if ((message.status === 'thinking' || message.status === 'answering') && thinkingAvatar) {
                                    <img class="w-8 h-8 pointer-events-none" [src]="thinkingAvatar"/>
                                } @else {
                                    <img class="w-8 h-8 pointer-events-none" [src]="assistantAvatar"/>
                                }
                            } @else {
                                <div class="w-8 h-8 rounded-full text-xl text-center font-notoColorEmoji">🤖</div>
                            }
                        </div>
                        <div class="flex-1 flex flex-col justify-start items-start overflow-auto relative pt-2 min-h-[50px] min-w-[50px] group">
                        @if (message.templateRef) {
                          <ng-container *ngTemplateOutlet="message.templateRef; context: {message: message}"></ng-container>
                        } @else {
                          @if (message.content) {
                            <div class="ngm-copilot-chat__message-content w-full" [ngClass]="{'thinking': message.status === 'thinking'}">
                                <markdown clipboard class="whitespace-pre-line"
                                    [clipboardButtonTemplate]="buttonTemplate"
                                    lineNumbers
                                    [start]="5"
                                    [data]="message.content"
                                ></markdown>

                              @if (showTokenizer$() && message.content) {
                                <ngm-copilot-token [content]="message.content"></ngm-copilot-token>
                              }

                              @if (message.status === 'done') {
                                <div class="flex self-end lg:self-center justify-center lg:justify-start mt-0 -ml-1 visible">
                                  @if (messageCopied().includes(message.id)) {
                                    <button class="flex items-center gap-1.5 rounded-md p-1 text-xs text-token-text-tertiary hover:text-token-text-primary md:invisible md:group-hover:visible md:group-[.final-completion]:visible
                                        transition-colors duration-100 text-neutral-400 hover:text-neutral-900 dark:hover:text-neutral-300"
                                    >
                                      <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg" class="icon-md">
                                        <path fill-rule="evenodd" clip-rule="evenodd"
                                          d="M18.0633 5.67375C18.5196 5.98487 18.6374 6.607 18.3262 7.06331L10.8262 18.0633C10.6585 18.3093 10.3898 18.4678 10.0934 18.4956C9.79688 18.5234 9.50345 18.4176 9.29289 18.2071L4.79289 13.7071C4.40237 13.3166 4.40237 12.6834 4.79289 12.2929C5.18342 11.9023 5.81658 11.9023 6.20711 12.2929L9.85368 15.9394L16.6738 5.93664C16.9849 5.48033 17.607 5.36263 18.0633 5.67375Z"
                                          fill="currentColor">
                                        </path>
                                      </svg>
                                    </button>
                                  } @else {
                                    <button class="flex items-center gap-1.5 rounded-md p-1 text-xs text-token-text-tertiary hover:text-token-text-primary md:invisible md:group-hover:visible md:group-[.final-completion]:visible
                                      transition-colors duration-100 text-neutral-400 hover:text-neutral-900 dark:hover:text-neutral-300"
                                      [matTooltip]="'Copilot.Copy' | translate: {Default: 'Copy'}"
                                      (click)="copyMessage(message)">
                                      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="icon-md">
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M12 4C10.8954 4 10 4.89543 10 6H14C14 4.89543 13.1046 4 12 4ZM8.53513 4C9.22675 2.8044 10.5194 2 12 2C13.4806 2 14.7733 2.8044 15.4649 4H17C18.6569 4 20 5.34315 20 7V19C20 20.6569 18.6569 22 17 22H7C5.34315 22 4 20.6569 4 19V7C4 5.34315 5.34315 4 7 4H8.53513ZM8 6H7C6.44772 6 6 6.44772 6 7V19C6 19.5523 6.44772 20 7 20H17C17.5523 20 18 19.5523 18 19V7C18 6.44772 17.5523 6 17 6H16C16 7.10457 15.1046 8 14 8H10C8.89543 8 8 7.10457 8 6Z" fill="currentColor"></path>
                                      </svg>
                                    </button>
                                  }

                                @if (conversation.command?.revert) {
                                  <button class="flex items-center gap-1.5 rounded-md p-1 text-xs text-token-text-tertiary hover:text-token-text-primary md:invisible md:group-hover:visible md:group-[.final-completion]:visible
                                    transition-colors duration-100 text-neutral-400 hover:text-neutral-900 dark:hover:text-neutral-300"
                                    [matTooltip]="'Copilot.Revert' | translate: {Default: 'Revert'}"
                                    (click)="conversation.command.revert(message.historyCursor)">
                                    <svg width="24" height="24" viewBox="0 0 500 500" xmlns="http://www.w3.org/2000/svg" class="icon-md">
                                      <defs></defs>
                                      <path fill="currentColor" d="M 454.773 346.315 C 442.015 227.344 354.517 135.227 248.471 135.227 C 197.384 135.27 148.054 156.727 109.563 195.654 L 109.563 162.034 C 109.563 141.437 90.318 128.503 74.908 138.824 C 67.772 143.622 63.33 152.486 63.33 162.034 L 63.33 269.227 C 63.33 284.047 73.685 296.037 86.445 296.037 L 179.161 296.037 C 196.936 296.037 208.027 273.725 199.139 255.823 C 195.019 247.559 187.397 242.463 179.161 242.463 L 133.944 242.463 C 164.687 208.072 205.742 188.887 248.471 188.844 C 329.973 188.844 398.756 259.163 408.946 352.954 C 410.744 373.509 431.006 384.088 445.44 372.012 C 452.449 366.142 456.079 356.25 454.773 346.315 M 62.188 376.634" style=""></path>
                                    </svg>
                                  </button>
                                }
                                    
                              <!-- <span class="" data-state="closed">
                                  <button class="p-1 rounded-md text-token-text-tertiary hover:text-token-text-primary md:invisible md:group-hover:visible md:group-[.final-completion]:visible
                                  text-neutral-400 hover:text-neutral-900 transition-colors duration-100 dark:hover:text-neutral-300"
                                  [matTooltip]="'Copilot.Regenerate' | translate: {Default: 'Regenerate'}"
                                  (click)="regenerate(message)"
                                  >
                                      <div class="flex items-center gap-1.5 text-xs">
                                          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="icon-md"><path fill-rule="evenodd" clip-rule="evenodd" d="M4.5 2.5C5.05228 2.5 5.5 2.94772 5.5 3.5V5.07196C7.19872 3.47759 9.48483 2.5 12 2.5C17.2467 2.5 21.5 6.75329 21.5 12C21.5 17.2467 17.2467 21.5 12 21.5C7.1307 21.5 3.11828 17.8375 2.565 13.1164C2.50071 12.5679 2.89327 12.0711 3.4418 12.0068C3.99033 11.9425 4.48712 12.3351 4.5514 12.8836C4.98798 16.6089 8.15708 19.5 12 19.5C16.1421 19.5 19.5 16.1421 19.5 12C19.5 7.85786 16.1421 4.5 12 4.5C9.7796 4.5 7.7836 5.46469 6.40954 7H9C9.55228 7 10 7.44772 10 8C10 8.55228 9.55228 9 9 9H4.5C3.96064 9 3.52101 8.57299 3.50073 8.03859C3.49983 8.01771 3.49958 7.99677 3.5 7.9758V3.5C3.5 2.94772 3.94771 2.5 4.5 2.5Z" fill="currentColor"></path></svg>
                                      </div>
                                  </button>
                              </span> -->
                                </div>
                              }
                            </div>
                          }
                            @if (message.error) {
                              <div class="ngm-copilot-chat__message-content text-red-400">
                                <span class="font-notoColorEmoji">🙈</span>
                                <span>{{ message.error }}</span>
                              </div>
                            }
                        }
        
                            <!-- <button mat-icon-button displayDensity="compact" class="ngm-copilot__message-remove left-0 top-0 opacity-0 group-hover:opacity-100 transition-opacity duration-100"
                                (click)="deleteMessage(message)">
                                <mat-icon>close</mat-icon>
                            </button> -->
                        </div>
                    </div>
                </div>
                }
              @case (CopilotChatMessageRoleEnum.User) {
                <div @fadeAnimation class="pl-4 flex">
                    <div class="flex-1 flex items-start justify-end overflow-auto">
                        <div class="flex-1 flex flex-col justify-start items-end overflow-auto relative p-[10px] group"
                            [class.ngm-copilot-chat__message-editing]="editingMessageId() === message.id">
                            @if (message.templateRef) {
                              <ng-container *ngTemplateOutlet="message.templateRef; context: {message: message}"></ng-container>
                            } @else {
                                @if (message.data) {
                                    <!-- <ngm-table class="max-w-full rounded-lg border overflow-hidden"
                                        [columns]="message.data['columns']"
                                        [data]="message.data['content']"
                                        paging
                                        [pageSizeOptions]="[10, 20, 50, 100]"
                                    ></ngm-table> -->
                                } @else {
                                  <div class="flex items-center gap-1 mb-[2px]">
                                    <button class="message-edit-button opacity-0 group-hover:opacity-100 flex items-center justify-center rounded-full transition p-1 hover:bg-black/5 dark:hover:bg-white/10"
                                      (click)="editMessageContent(message.id, msgContent)">
                                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-md"><path fill="currentColor" fill-rule="evenodd" d="M13.293 4.293a4.536 4.536 0 1 1 6.414 6.414l-1 1-7.094 7.094A5 5 0 0 1 8.9 20.197l-4.736.79a1 1 0 0 1-1.15-1.151l.789-4.736a5 5 0 0 1 1.396-2.713zM13 7.414l-6.386 6.387a3 3 0 0 0-.838 1.628l-.56 3.355 3.355-.56a3 3 0 0 0 1.628-.837L16.586 11zm5 2.172L14.414 6l.293-.293a2.536 2.536 0 0 1 3.586 3.586z" clip-rule="evenodd"></path></svg>
                                    </button>

                                    @if (showTokenizer$() && message.content) {
                                      <ngm-copilot-token [content]="message.content"></ngm-copilot-token>
                                    }
                                    @if (message.command) {
                                      <span class="text-xs font-medium italic px-2.5 py-0.5 rounded bg-gray-200/50 dark:bg-neutral-700">/{{message.command}}</span>
                                    }
                                  </div>
                                  <div class="ngm-copilot-chat__message-content ngm-copilot__user-message relative flex flex-col items-end">
                                      <div #msgContent class="ngm-copilot-chat__message-edit whitespace-pre-wrap w-full focus-visible:outline-none
                                        focus-visible:bg-white dark:focus-visible:bg-black"
                                      >{{ message.content }}</div>

                                      @if (editingMessageId() === message.id) {
                                        <div class="flex items-center gap-1 mt-2">
                                          <button mat-stroked-button class="ngm-copilot__resubmit" displayDensity="compact"
                                            (click)="cancelMessageContent(msgContent)">
                                            {{ 'Copilot.Cancel' | translate: {Default: 'Cancel'} }}
                                          </button>
                                          <button mat-flat-button class="ngm-copilot__resubmit" color="primary" displayDensity="compact"
                                              (click)="resubmitMessage(msgContent, conversation.id, message, msgContent.textContent)">
                                              {{ 'Copilot.Update' | translate: {Default: 'Update'} }}
                                          </button>
                                        </div>
                                      }
                                  </div>
                                }
                            }

                          @if (message.error) {
                            <div class="ngm-error">
                                {{ message.error }}
                            </div>
                          }
        
                            <!-- <button mat-icon-button displayDensity="compact" class="ngm-copilot__message-remove right-0 top-0 opacity-0 group-hover:opacity-100 transition-opacity duration-100"
                                (click)="deleteMessage(message)">
                                <mat-icon>close</mat-icon>
                            </button> -->
                        </div>
                        
                        <ngm-copilopt-user-avatar class="shrink-0 w-8 h-8 rounded-full overflow-hidden" [user]="user"></ngm-copilopt-user-avatar>
                    </div>
                </div>
              }
              @case (CopilotChatMessageRoleEnum.Info) {
                <div @fadeAnimation class="pl-4 flex">
                    <div class="flex-1 flex items-start justify-end overflow-auto">
                        <div class="rounded-lg py-2 px-4 w-full overflow-auto flex flex-col items-end">
                            {{ message.content }}
                        </div>
                    </div>
                </div>
              }
            }
        }

        @if (!last) {
          <mat-divider class="pb-4"></mat-divider>
        }
      }

      @if (!conversations()?.length) {
        <div class="absolute top-0 bottom-0 w-full p-4 flex flex-col justify-center items-center gap-1">
          <div @fadeAnimation class="text-xl drop-shadow-md mb-4">
            <span class="text-xl">💡</span>{{ 'Copilot.AskAICopilot' | translate: {Default: 'Ask AI Copilot Questions'} }}
          </div>

          @if (roles()) {
            <label @fadeAnimation>{{'Copilot.PleaseSelectBusinessRole' | translate: {Default: 'Please select a business role'} }}</label>
            <mat-chip-listbox class="ngm-copilot-chat__roles mb-4" [(ngModel)]="role">
              @for (item of roles(); track $index) {
                <mat-chip-option @fadeAnimation [selected]="role() === item.name" [value]="item.name"
                  [matTooltip]="item.description"
                  matTooltipPosition="above"
                  >{{item.title}}</mat-chip-option>
              }
            </mat-chip-listbox>
          }
        </div>
      }
    </div>

    <ngm-scroll-back #scrollBack class="block absolute bottom-0 left-1/2" [class.animate-bounce]="answering()"
      [ngmTarget]="chatsContent" direction="bottom" />
</div>

<div class="relative m-3 border rounded-2xl shadow-sm overflow-hidden border-neutral-100 dark:border-neutral-800 bg-neutral-100 dark:bg-neutral-800"
    [class.ngm-colpilot__active]="isFoucs(userInput)"
    (click)="userInput.focus()"
>
    <mat-progress-bar mode="buffer" [class.opacity-100]="answering()" class="opacity-0 top-0 left-0 w-full transition duration-300" style="position: absolute; z-index: 1;"></mat-progress-bar>

    <div class="relative flex flex-col m-1">

      @if (command()) {
        <div class="flex flex-col divide-y overflow-hidden rounded-b-md rounded-t-xl bg-white dark:bg-black">
          <div class="flex items-center py-2 gap-2 pl-3 pr-1.5 text-sm whitespace-nowrap">
            <span class="font-bold">{{command().name}}</span>
            @if (context()) {
              <span class="flex items-center px-1 py-0.5 rounded-full bg-neutral-50 dark:bg-neutral-900 cursor-pointer"
                [matTooltip]="context().caption"
                [matMenuTriggerFor]="contextMenu"
                [matMenuTriggerData]="{word: {text: context().uKey }}"
                (click)="$event.stopPropagation()">{{context().caption}}<button class="flex-shrink-0 hover:text-red-500" (click)="removeContext()"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" class="icon-lg"><path fill="currentColor" fill-rule="evenodd" d="M7.293 7.293a1 1 0 0 1 1.414 0L12 10.586l3.293-3.293a1 1 0 1 1 1.414 1.414L13.414 12l3.293 3.293a1 1 0 0 1-1.414 1.414L12 13.414l-3.293 3.293a1 1 0 0 1-1.414-1.414L10.586 12 7.293 8.707a1 1 0 0 1 0-1.414" clip-rule="evenodd"></path></svg></button></span>
            }
            <span class="overflow-hidden text-ellipsis">{{command().description}}</span>
          </div>
        </div>
      }

      <div class="ngm-colpilot__input-wrapper mt-2 relative flex">
        <textarea #userInput matInput class="ngm-colpilot__input w-full h-full px-1.5 z-10 resize-none overflow-visible"
          id="userInput" onInput="this.parentNode.dataset.replicatedValue = this.value"
          [placeholder]="_placeholder || (('Copilot.Placeholder' | translate: {Default: 'Ask Copilot or type / for commands'}) + '\nEnter ' + ('Copilot.SendPrompt' | translate: {Default: 'send prompt'}))"
          [formControl]="promptControl"
          (keydown)="triggerFun($event, autoPrompts)"

          [matAutocomplete]="autoPrompts"
          matAutocompletePosition="above"

          cdkTextareaAutosize
          cdkAutosizeMinRows="2"
          cdkAutosizeMaxRows="5"
        >
        </textarea>

          <!-- <div class="ngm-colpilot__words absolute top-0 block z-20 whitespace-pre-wrap">
            @for (line of promptWords(); track $index; let last = $last) {
              @for (word of line; track $index) {
                @switch (word.type) {
                  @case('command') {
                    <span class="rounded-md cursor-pointer bg-neutral-200 dark:bg-neutral-600" [matTooltip]="word.description | async">{{word.text}}</span>
                  }
                  @case('context') {
                    <span class="rounded-md cursor-pointer bg-neutral-200 dark:bg-neutral-600"
                        [matTooltip]="word.description | async"
                        [matMenuTriggerFor]="contextMenu"
                        [matMenuTriggerData]="{word: word, index: $index}"
                        (click)="$event.stopPropagation()"
                        >{{word.text}}</span>
                  }
                  @default {
                    <span class="opacity-0">{{word.text}}</span>
                  }
                }
                <span>{{' '}}</span>
              }
              @if (!last) {
                <br>
              }
            }
          </div> -->
          
        @if (promptCompletion()) {
          <div class="absolute top-0 left-0 px-1.5 whitespace-pre-wrap">
              <span class="opacity-30 z-0">{{prompt()}}<span class="italic">{{promptCompletion()}}</span></span>
          </div>
        }
      </div>

        <mat-autocomplete #autoPrompts="matAutocomplete" class="ngm-copilot-chat__autocomplete-panel ngm-autocomplete-panel ngm-density__compact"
            autoActiveFirstOption hideSingleSelectionIndicator
            (optionActivated)="onPromptActivated($event)"
            (opened)="suggestionsOpened$.next(true)"
            (closed)="suggestionsOpened$.next(false)"
        >

          @if (loadingContext$ | async) {
            <mat-progress-bar mode="query" role="progressbar"
                color="accent"
                class="top-0 left-0 w-full"
                style="position: absolute; height: 2px;"
                />
            <mat-option [value]="null"></mat-option>
          } @else if (filteredContextItems()) {
            <cdk-virtual-scroll-viewport class="nx-formly__virtual-scroll-viewport" minBufferPx="200" maxBufferPx="400"
                [style.height.px]="240" [itemSize]="30"
            >
              <mat-option *cdkVirtualFor="let item of filteredContextItems(); trackBy: trackByKey"
                [value]="beforeLastWord() + ' @' + item.uKey + ' '"
                (click)="setContext(item)">
                <div class="flex-1" [ngmHighlight]="contextSearchWords()?.[0]">
                  <span class="flex-1">{{item.caption}}</span>
                  <span>{{item.key}}</span>
                </div>
              </mat-option>
            </cdk-virtual-scroll-viewport>
          }

          @for (command of filteredCommands();  track command.prompt) {
            <mat-option [value]="'/'+command.name+' '+(command.example || '')" [title]="command.description">
                <span class="bg-gray-200 text-neutral-800 text-xs font-medium me-2 px-1 mr-1 rounded dark:bg-gray-900 dark:text-neutral-300"
                >/{{command.name}}</span>
              @if (command.alias) {
                <span class="bg-gray-200 text-neutral-800 text-xs font-medium me-2 px-1 mr-1 rounded dark:bg-gray-900 dark:text-neutral-300"
                >/{{command.alias}}</span>
              }

              @if (command.example) {
                <div class="whitespace-nowrap text-ellipsis overflow-hidden text-gray-500 italic"
                    [ngmHighlight]="prompt()"
                    [content]="command.example"
                    customClasses="text-gray-600 bg-gray-200 font-bold not-italic"
                >{{command.example}}</div>
              } @else {
                <span class="ml-auto opacity-50">{{command.description}}</span>
              }
            </mat-option>
          }
        </mat-autocomplete>

        <div class="shrink-0 flex items-center">
            <button mat-icon-button type="button" displayDensity="cosy"
                [popper]="copilotOptions"
                [popperTrigger]="NgxPopperjsTriggers.click"
                [popperHideOnClickOutside]="true"
                [popperHideOnScroll]="true"
                [popperHideOnMouseLeave]="false"
                [popperPlacement]="NgxPopperjsPlacements.TOPEND"
                (click)="$event.stopPropagation()"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="h-5 w-5 shrink-0"><path fill="currentColor" fill-rule="evenodd" d="M11.568 3.5a1 1 0 0 0-.863.494l-.811 1.381A3 3 0 0 1 7.33 6.856l-1.596.013a1 1 0 0 0-.858.501l-.44.761a1 1 0 0 0-.003.992l.792 1.4a3 3 0 0 1 0 2.954l-.792 1.4a1 1 0 0 0 .004.992l.439.76a1 1 0 0 0 .858.502l1.596.013a3 3 0 0 1 2.564 1.48l.811 1.382a1 1 0 0 0 .863.494h.87a1 1 0 0 0 .862-.494l.812-1.381a3 3 0 0 1 2.563-1.481l1.596-.013a1 1 0 0 0 .859-.501l.439-.761a1 1 0 0 0 .004-.992l-.793-1.4a3 3 0 0 1 0-2.953l.793-1.401a1 1 0 0 0-.004-.992l-.439-.76a1 1 0 0 0-.859-.502l-1.596-.013a3 3 0 0 1-2.563-1.48L13.3 3.993a1 1 0 0 0-.862-.494zM8.98 2.981A3 3 0 0 1 11.568 1.5h.87a3 3 0 0 1 2.588 1.481l.81 1.382a1 1 0 0 0 .855.494l1.597.013a3 3 0 0 1 2.575 1.502l.44.76a3 3 0 0 1 .011 2.975l-.792 1.4a1 1 0 0 0 0 .985l.792 1.401a3 3 0 0 1-.012 2.974l-.439.761a3 3 0 0 1-2.575 1.503l-1.597.012a1 1 0 0 0-.854.494l-.811 1.382a3 3 0 0 1-2.588 1.481h-.87a3 3 0 0 1-2.588-1.481l-.811-1.382a1 1 0 0 0-.855-.494l-1.596-.012a3 3 0 0 1-2.576-1.503l-.439-.76a3 3 0 0 1-.012-2.975l.793-1.4a1 1 0 0 0 0-.985l-.793-1.4a3 3 0 0 1 .012-2.975l.44-.761A3 3 0 0 1 5.717 4.87l1.596-.013a1 1 0 0 0 .855-.494z" clip-rule="evenodd"></path><path fill="currentColor" fill-rule="evenodd" d="M12.003 10.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3M8.502 12a3.5 3.5 0 1 1 7 .001 3.5 3.5 0 0 1-7-.001" clip-rule="evenodd"></path></svg>
            </button>

            <span class="flex-1"></span>
            
            @if (answering()) {
              <button type="button" class="rounded-full md:bottom-3 md:right-3 right-2 border-solid p-1 hover:opacity-60 text-white bg-black dark:bg-white dark:text-black" aria-label="停止生成"
                (click)="stopGenerating()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="icon-lg"><rect width="10" height="10" x="7" y="7" fill="currentColor" rx="1.25"></rect></svg>
              </button>
            } @else {
              <button type="button" class="rounded-full md:bottom-3 md:right-3 right-2 border-solid p-1 bg-black disabled:opacity-10 disabled:text-gray-400 enabled:bg-black text-white dark:border-white dark:bg-white bottom-1.5 transition-colors
                hover:opacity-60" data-testid="send-button"
                [disabled]="!prompt()"
                (click)="askCopilotStream(promptControl.value)"
              >
                <span class="" data-state="closed">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" class="text-white dark:text-black">
                    <path d="M7 11L12 6L17 11M12 18V7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                  </svg>
                </span>
              </button>
            }
        </div>
    </div>
</div>

@if (!copilotEnabled()) {
  <ngm-copilot-enable class="z-[101]"
    [title]="welcomeTitle || 'Metad Copilot'"
    [subTitle]="welcomeSubTitle || ('Copilot.YourAIPairProgrammer' | translate: {Default: 'Your AI pair programmer'})"
    (toConfig)="onEnableCopilot()"/>
}

<popper-content #copilotOptions class="z-[101]">
    <div class="w-80 flex flex-col max-w-sm p-4 border-0 border-gray-200 rounded-lg shadow-lg
        dark:bg-gray-800/20 dark:border-gray-700 bg-white/60 backdrop-blur-lg"
        displayDensity="compact">
        <div class="text-base mb-2">
            {{ 'Copilot.Options' | translate: {Default: 'Options'} }}
        </div>

        <div class="mt-2 font-notoColorEmoji flex justify-between items-center">
            <label class="shrink-0">
                {{ 'Copilot.Model' | translate: {Default: 'Model'} }}:<span matTooltip="ID of the model to use.">💡</span>
            </label>

            <ngm-search class="flex-1" [formControl]="searchModel"/>

          @if (canListModels()) {
            <button mat-icon-button displayDensity="compact" (click)="refreshModels()">
                <mat-icon>refresh</mat-icon>
            </button>
          }
        </div>
        
        <mat-selection-list class="flex flex-col gap-2 max-h-[120px] overflow-auto"
            [(ngModel)]="selectedModel"
            [multiple]="false"
            (ngModelChange)="changeSelectedModel($event)">
          @for (model of models(); track model.id) {
            <mat-list-option [value]="model.id" class="rounded-md">
                {{model.name}}
            </mat-list-option>
          }
        </mat-selection-list>

        <label class="pt-4 font-notoColorEmoji">Temperature:<span matTooltip="What sampling temperature to use, between 0 and 2. Higher values like 0.8 will make the output more random, while lower values like 0.2 will make it more focused and deterministic. We generally recommend altering this or top_p but not both.">💡</span></label>
        <mat-slider color="accent" min="0" max="2" step="0.1" value="1" discrete>
            <input matSliderThumb [(ngModel)]="temperature">
        </mat-slider>
        
        <label class="pt-4 font-notoColorEmoji">Choices:<span matTooltip="How many chat completion choices to generate for each input message.">💡</span></label>
        <mat-slider color="accent" min="1" max="10" step="1" value="1" discrete>
            <input matSliderThumb [(ngModel)]="n">
        </mat-slider>

        <mat-checkbox [(ngModel)]="verbose" color="accent" labelPosition="before">Verbose</mat-checkbox>

        <button mat-stroked-button displayDensity="cosy" class="pac-colpilot__clear-messages mt-4" (click)="clear()">
            {{ 'Copilot.ClearMessages' | translate: {Default: 'Clear messages'} }}
        </button>
    </div>
</popper-content>

<ng-template #buttonTemplate>
    <!-- <button mat-flat-button displayDensity="compact" class="ngm-rounded-full"
        (click)="run($event)">run</button> -->
    <button #copyButton mat-flat-button displayDensity="compact" class="ngm-rounded-full" (click)="onCopy(copyButton)">
      @if ($any(copyButton).copied) {
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="icon-md">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M18.0633 5.67375C18.5196 5.98487 18.6374 6.607 18.3262 7.06331L10.8262 18.0633C10.6585 18.3093 10.3898 18.4678 10.0934 18.4956C9.79688 18.5234 9.50345 18.4176 9.29289 18.2071L4.79289 13.7071C4.40237 13.3166 4.40237 12.6834 4.79289 12.2929C5.18342 11.9023 5.81658 11.9023 6.20711 12.2929L9.85368 15.9394L16.6738 5.93664C16.9849 5.48033 17.607 5.36263 18.0633 5.67375Z" fill="currentColor">
            </path>
        </svg>
      } @else {
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="icon-md">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M12 4C10.8954 4 10 4.89543 10 6H14C14 4.89543 13.1046 4 12 4ZM8.53513 4C9.22675 2.8044 10.5194 2 12 2C13.4806 2 14.7733 2.8044 15.4649 4H17C18.6569 4 20 5.34315 20 7V19C20 20.6569 18.6569 22 17 22H7C5.34315 22 4 20.6569 4 19V7C4 5.34315 5.34315 4 7 4H8.53513ZM8 6H7C6.44772 6 6 6.44772 6 7V19C6 19.5523 6.44772 20 7 20H17C17.5523 20 18 19.5523 18 19V7C18 6.44772 17.5523 6 17 6H16C16 7.10457 15.1046 8 14 8H10C8.89543 8 8 7.10457 8 6Z" fill="currentColor"></path>
        </svg>
      }
    </button>
</ng-template>


<mat-menu #contextMenu="matMenu" class="ngm-menu__copilot-context-popper ngm-density__compact">
    <ng-template matMenuContent let-word="word">
        <ngm-search class="m-2 mb-0" (click)="$event.stopPropagation()" [(ngModel)]="contextMenuSearch" />
      @if (loadingContext$ | async) {
        <mat-progress-bar mode="query" role="progressbar"
            color="accent"
            class="top-0 left-0 w-full" 
            style="position: absolute; height: 2px;"/>
      } @else if (filteredContextMenuItems()) {
        <cdk-virtual-scroll-viewport minBufferPx="200" maxBufferPx="400"
            [style.height.px]="240" [itemSize]="30"
        >
            <button mat-menu-item *cdkVirtualFor="let item of filteredContextMenuItems(); trackBy: trackByKey"
              [ngClass]="{active: item.uKey === word.text}"
              (click)="repleaceContext(word.text, item)"
            >
              <div class="flex-1" [ngmHighlight]="contextMenuSearch()">
                <span class="flex-1">{{item.caption}}</span>
                <span>{{item.key}}</span>
              </div>
            </button>
        </cdk-virtual-scroll-viewport>
      }
    </ng-template>
</mat-menu>
