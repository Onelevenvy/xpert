<mat-sidenav-container class="flex-1">
  <mat-sidenav #sidenav [(opened)]="sidenavOpened" [mode]="isMobile() ? 'over' : 'side'" class="w-[400px]">
    <pac-chat-sidenav-menu class="w-full p-2" [sidenav]="sidenav"/>

    <div class="flex-1 p-2 overflow-auto max-h-fit"
      waIntersectionObserver
      waIntersectionThreshold="0.5"
    >
      <ul cdkListbox>
        @for (xpert of xperts(); track xpert.id) {
          <li [cdkOption]="role" class="flex items-center cursor-pointer px-4 py-2 rounded-lg truncate
            active:scale-95 transition-transform
           hover:bg-black/5 dark:hover:bg-white/10"
            (click)="selectXpert(xpert)"
          ><emoji-avatar [avatar]="xpert.avatar" xs class="rounded-lg overflow-hidden shadow-sm mr-1" />{{xpert.title || xpert.name}}</li>
        } @empty {
          @if (hasEditXpertPermission()) {
            <div class="w-full flex justify-center">
              <button type="button" class="btn btn-primary px-3 py-1"
                routerLink="/xpert/w"
              >
                {{ 'PAC.Chat.GotoNewXpert' | translate: {Default: 'Go to New Digital Expert'} }}
                <i class="ri-corner-up-right-fill ml-1 text-lg"></i>
              </button>
            </div>
          }
        }
      </ul>

      <mat-list>
        @for (group of groups(); track groups.name) {
          <div mat-subheader class="pt-8 text-sm font-semibold text-ellipsis overflow-hidden break-all text-token-text-primary">
            {{ 'PAC.KEY_WORDS.Date_' + group.name | translate: {Default: group.name} }}</div>
          @for (item of group.values; track item.id) {
            <mat-list-item class="pac-chat__conversation-item group cursor-pointer rounded-md hover:bg-black/5 dark:hover:bg-white/10"
              [ngClass]="{active: item.id === conversationId()}"
              [class.menu-active]="mt.isOpen()"
              (click)="selectConversation(item)"
            >
            @if (editingConversation()  === item.id) {
              <input matInput [(ngModel)]="editingTitle" (keydown.enter)="updateTitle(item)">
            } @else {
              {{item.title || item.id}}
            }

              <div class="absolute bottom-0 top-0 items-center gap-1.5 pr-2 right-0 flex">
                <span class="" data-state="closed">
                  <button class="menu-trigger flex items-center justify-center p-1 rounded-full text-token-text-secondary transition opacity-0
                    group-hover:opacity-50 group-hover:hover:opacity-100 hover:bg-hover-bg"
                    type="button"
                    [cdkMenuTriggerFor]="convMenu"
                    [cdkMenuTriggerData]="item"
                    #mt="cdkMenuTriggerFor"
                    [class.active]="mt.isOpen()"
                    [matTooltip]="'PAC.KEY_WORDS.Options' | translate: {Default: 'Options'} "
                    matTooltipPosition="above"
                    (click)="$event.stopPropagation();">
                    <pac-chat-more-svg />
                  </button>
                </span>
              </div>
            </mat-list-item>
          }
        }
      </mat-list>

      @if (loading()) {
        <div class="flex justify-center">
          <mat-progress-spinner [diameter]="20" color="accent" mode="indeterminate" />
        </div>
      }

      <div (waIntersectionObservee)="onIntersection()" class="p-4"></div>
    </div>
  </mat-sidenav>
  <mat-sidenav-content class="overflow-auto">
    <pac-chat-toolbar class="sticky top-0 z-10 bg-components-panel-bg"
      [chatInput]="chatInput">
      @if (!sidenav.opened) {
        <pac-chat-sidenav-menu [sidenav]="sidenav"/>
      }
    </pac-chat-toolbar>

    <div #contentContainer class="w-full flex-1 px-2 lg:w-[800px] lg:px-8 max-w-full m-auto">

      @if (!conversationId() && !messages()?.length && role()) {
        <div class="w-full h-full flex flex-col justify-center items-center gap-4">
          <emoji-avatar [avatar]="role().avatar" large class="rounded-xl overflow-hidden shadow-sm" />

          <div class="w-full flex flex-col items-center gap-2">
            <p class="text-xl">{{role().title || role().name}}</p>
            <p class="text-token-text-secondary">{{role().description}}</p>
          </div>

          <div class="mx-3 mt-12 flex max-w-3xl flex-wrap items-stretch justify-center gap-4 mb-8">
            @for (statement of role().starters; track statement) {
              @if (statement) {
                <button class="relative flex w-40 flex-col gap-2 rounded-2xl border border-token-border-light px-3 pb-4 pt-3 text-start align-top text-[15px] shadow-sm transition enabled:hover:bg-token-main-surface-secondary disabled:cursor-not-allowed"
                  (click)="chatInput.ask(statement)"
                >
                  <div class="line-clamp-3 max-w-full text-balance font-light text-neutral-500 dark:text-neutral-500 break-word">
                    {{statement}}
                  </div>
                </button>
              }
            }
          </div>

        </div>
      } @else {
        <pac-chat-conversation class="w-full lg:w-[800px] max-w-full m-auto py-4 lg:p-8"/>
      }
    </div>

    <pac-chat-input #chatInput cdkTrapFocusAutoCapture class="w-full px-4 lg:w-[800px] lg:px-8 max-w-full m-auto sticky bottom-0 z-10 bg-components-panel-bg"/>
  </mat-sidenav-content>
</mat-sidenav-container>

<ng-template #convMenu let-id="id" let-title="title">
  <div cdkMenu class="cdk-menu__medium">
    <button cdkMenuItem (click)="editingConversation.set(id);editingTitle.set(title)">
      <i class="ri-edit-line mr-1"></i>
      {{ 'PAC.KEY_WORDS.Rename' | translate: {Default: 'Rename'} }}
    </button>

    <button cdkMenuItem class="danger" (click)="deleteConv(id)">
      <i class="ri-delete-bin-4-line mr-1"></i>
      {{ 'PAC.KEY_WORDS.Delete' | translate: {Default: 'Delete'} }}
    </button>
  </div>
</ng-template>