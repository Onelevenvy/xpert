<div class="relative flex justify-center items-center p-4">

  <a class="absolute left-2 h-12 pl-2 pr-6 py-2 justify-start items-center gap-1 inline-flex cursor-pointer" (click)="close()">
    <div class="p-2 font-semibold">
      <i class="ri-arrow-left-line text-text-primary"></i>
    </div>
    <p class="text-text-primary system-sm-semibold-uppercase">文档</p>
  </a>

  <ol class="lg:flex justify-center items-center w-full space-y-4 lg:space-y-0 lg:space-x-4">
    <li class="relative step flex items-center font-medium"
      [class.active]="step() === 0"
      (click)="step.set(0)"
    >
      <span class="step-num w-6 h-6 flex justify-center items-center mr-3 text-sm lg:w-8 lg:h-8"> 1 </span>
      <div class="block">
        <h4 class="text-base">文件源</h4>
      </div>

      <i class="ri-arrow-right-double-line text-lg ml-2 sm:ml-4"></i>
    </li>
    <li class="relative step flex items-center font-medium"
      [class.active]="step() === 1"
      (click)="step.set(1)"
    >
      <span class="step-num w-6 h-6 flex justify-center items-center mr-3 text-sm lg:w-8 lg:h-8">2</span>
      <div class="block">
        <h4 class="text-base">文本处理</h4>
      </div>

      <i class="ri-arrow-right-double-line text-lg ml-2 sm:ml-4"></i>
    </li>
    <li class="relative step flex items-center font-medium"
      [class.active]="step() === 2"
      (click)="step.set(2)"
    >
      <span class="step-num w-6 h-6 flex justify-center items-center mr-3 text-sm lg:w-8 lg:h-8">3</span>
      <div class="block">
        <h4 class="text-base">完成</h4>
      </div>
    </li>
  </ol>
</div>

@if (step() === 0) {
  <div class="grow flex">
    <div class="px-8 py-4 w-[640px]">
      <div class="z-10 mb-4 font-semibold text-lg text-text-primary">选择文件源</div>

      <ol class="flex flex-wrap gap-2 items-start" cdkListbox [(ngModel)]="sourceType">
        @for (option of fileTypeOptions; track option.value) {
          <li #opt="cdkOption" class="type-option relative flex flex-col w-80 h-32 max-w-xs border border-solid border-gray-200 rounded-2xl p-4 cursor-pointer
            hover:bg-gray-50 hover:shadow-sm"
            [cdkOption]="option.value"
            [class.active]="opt.isSelected()"
          >
            <div class="flex justify-start items-center gap-1 mb-2">
              @if (opt.isSelected()) {
                <i class="ri-checkbox-circle-line text-2xl leading-none text-primary-500"></i>
              }
              <h4 class="text-base font-semibold text-gray-900 capitalize transition-all duration-500 ">
                {{option.label | i18n}}
              </h4>
            </div>
            
            <p class="grow text-sm font-normal text-gray-500 transition-all duration-500 leading-5 mb-4 line-clamp-2">
              {{option.description | i18n}}
            </p>
            <a href="javascript:;" class="group flex items-center gap-2 text-sm font-light text-text-primary transition-all duration-100 hover:text-primary-500">
              Read More
              <i class="ri-external-link-line transition-all group-hover:translate-x-1"></i>
            </a>
          </li>
        }
      </ol>

      @if (sourceType()[0] === eKDocumentSourceType.FILE) {
        <div class="my-6 w-full">
          <input id="fileUploader" #fileDropRef class="invisible" multiple accept=".txt,.markdown,.md,.mdx,.pdf,.html,.htm,.xlsx,.xls,.docx,.csv,.TXT,.MARKDOWN,.MD,.MDX,.PDF,.HTML,.HTM,.XLSX,.XLS,.DOCX,.CSV" type="file"
            (change)="fileBrowseHandler($event.target)"
            (click)="fileDropRef.value=null;">
          <div class="text-text-tertiary text-base font-semibold leading-6 mb-2">上传文本文件</div>
          <div class="relative box-border flex flex-col justify-center items-center gap-1 mb-2 px-4 py-3 max-w-[640px] min-h-20 text-sm text-text-tertiary border border-dashed border-components-dropzone-border rounded-xl bg-gray-50"
            ngmDnd (fileDropped)="onFileDropped($event)"
          >
            <div class="flex justify-center items-center min-h-5 text-sm leading-4 text-text-secondary">
              <i class="ri-upload-cloud-line"></i>
              <span>拖拽文件至此，或者<label for="fileUploader" class="ml-1 text-text-accent cursor-pointer">选择文件</label></span>
            </div>
            <div>已支持 TXT、 MARKDOWN、 MDX、 PDF、 HTML、 XLSX、 XLS、 DOCX、 CSV、 MD、 HTM，每个文件不超过 15MB。</div>
          </div>

          <div class="space-y-1 max-w-[640px] cursor-default">
            @for (item of fileList(); track item) {
              <div class="relative flex items-center h-14 max-w-[640px] text-sm leading-3 text-text-tertiary border-[0.5px] rounded-lg hover:shadow-sm hover:bg-gray-50"
                (click)="selectFile(item)"
              >
                <div class="shrink-0 flex justify-center items-center w-12 text-[#2684FF]">
                  @switch (item.extension) {
                    @case ('docx') {
                      <i class="ri-file-word-fill text-lg"></i>
                    }
                    @case ('doc') {
                      <i class="ri-file-word-fill text-lg"></i>
                    }
                    @case ('txt') {
                      <i class="ri-file-text-fill text-lg"></i>
                    }
                    @case ('pdf') {
                      <i class="ri-file-pdf-2-fill text-lg"></i>
                    }
                    @default {
                      <i class="ri-file-text-fill text-lg"></i>
                    }
                  }
                </div>
                <div class="grow shrink flex flex-col gap-0.5">
                  <div class="flex w-full">
                    <div class="text-sm leading-4 text-text-secondary w-0 grow truncate">{{item.file.name}}</div>
                  </div>
                  <div class="w-full leading-3 truncate text-text-tertiary">
                    <span class="uppercase">{{item.file.name.split('.').pop()}}</span>
                    <span class="px-1 text-text-quaternary">·</span>
                    <span>{{item.file.size}}</span>
                  </div>
                </div>

                @if (item.loading) {
                  <ngm-spin small class="mr-4"/>
                } @else {
                  <button type="button" class="btn danger shrink-0 flex items-center justify-center w-6 h-6 mr-4 rounded-md"
                    (click)="removeFile(item)"
                  >
                    <i class="ri-delete-bin-line"></i>
                  </button>
                }

                <mat-progress-bar class="absolute bottom-0 left-0 w-full" mode="determinate" [value]="item.progress" [color]="item.progress === 100 ? 'primary' : 'accent'" />
              </div>
            }
          </div>
        </div>

        <div class="flex justify-end gap-2 max-w-[640px]">
          <button type="button" class="btn disabled:btn-disabled btn-primary btn-medium"
            (click)="nextStep()">
            <span class="flex gap-0.5 px-[10px]">
              <span class="px-0.5">下一步</span>
              <i class="ri-arrow-right-line"></i>
            </span>
          </button>
        </div>
      }

      @if (sourceType()[0] === eKDocumentSourceType.WEB) {
        <div class="my-6 w-full flex flex-wrap gap-2">
          @for (type of webTypes; track type) {
            <div class="w-40 h-20 p-4 rounded-lg border border-solid border-divider-regular shadow-sm hover:bg-gray-50">
              {{type.label | i18n}}</div>
          }
        </div>
      }
    </div>

    @if (previewFile(); as item) {
      <div class="h-full w-[1px] bg-divider-deep"></div>
      <div class="w-1/2 h-full overflow-y-auto">
        <div class="h-full">
          <div class="p-4">
            <div class="w-full flex justify-between items-center">
              <span>文件预览</span>
              <div class="flex items-center justify-center w-6 h-6 cursor-pointer"
                (click)="closePreview()"
              >
                <i class="ri-close-line"></i>
              </div>
            </div>
            <div class="file-preview_fileName__cj3IL">
              <span>{{item.storageFile.file}},</span>
              <span class="">.{{item.storageFile.mimetype}}</span>
            </div>
          </div>
          <div class="">
            <div class="">导入员工</div>
          </div>
        </div>
      </div>
    }
  </div>
}

@if (step() === 1) {
  <div class="py-4 flex w-full grow overflow-hidden">
    <div class="grow max-w-[50%] flex flex-col px-8 py-4 overflow-auto">
      <div class="system-md-semibold mb-1">分段设置</div>

      <div class="rounded-xl shadow-xs border-[1.5px] mb-2">
        <div class="flex overflow-hidden rounded-t-xl relative cursor-pointer">
          <div class="px-2 flex justify-center items-center">
            <div class="w-8 h-8 flex items-center justify-center relative overflow-hidden shadow-md rounded-lg bg-gray-100">
              <i class="ri-equalizer-3-line"></i>
            </div>
          </div>
          
          <div class="flex-1 space-y-0.5 py-3 pr-4">
            <div class="text-text-secondary system-md-semibold">通用</div>
            <div class="text-text-tertiary system-xs-regular">通用文本分块模式，检索和回忆的块是相同的</div>
          </div>
        </div>
        <div class="py-3 px-4 bg-components-panel-bg rounded-b-xl">
          <div class="flex flex-col gap-y-4">
            <div class="flex gap-3">
              <div class="space-y-2 flex-1">
                <ngm-input label="分段标识符" [(ngModel)]="delimiter" />
              </div>
              <div class="space-y-2 flex-1">
                <ngm-input label="分段最大长度" type="number" [(ngModel)]="chunkSize" />
              </div>
              <div class="space-y-2 flex-1">
                <ngm-input label="分段重叠长度" type="number" [(ngModel)]="chunkOverlap" />
              </div>
            </div>
            <div class="w-full flex flex-col">
              <div class="flex items-center gap-x-2">
                <div class="inline-flex shrink-0">
                  <label class="text-text-secondary system-sm-semibold">文本预处理规则</label>
                </div>
                <div class="w-full h-[0.5px] my-2 bg-gradient-to-r from-divider-regular grow"></div>
              </div>
              <div class="mt-1">
                <ngm-checkbox label="替换掉连续的空格、换行符和制表符" class="mb-4" />
                <ngm-checkbox label="删除所有 URL 和电子邮件地址" class="mb-2" />

                <div class="w-full h-[0.5px] my-4 bg-divider-subtle"></div>

                <div class="flex items-center py-0.5">

                  <ngm-checkbox label="使用 Q&amp;A 分段，语言" />

                  <ngm-select class="ml-2 w-36" placeholder="选择语言"
                    [selectOptions]="[
                      {
                        value: 'Chinese',
                        label: {
                          en_US: 'Chinese'
                        }
                      },
                      {
                        value: 'English',
                        label: {
                          en_US: 'English'
                        }
                      }
                    ]"/>
                </div>
              </div>
            </div>
          </div>
          <div class="flex gap-2 mt-4">
            <button type="button" class="btn disabled:btn-disabled btn-secondary-accent btn-medium">
              <i class="ri-search-eye-line"></i>
              预览块</button>
            <button type="button" class="btn disabled:btn-disabled btn-ghost btn-medium">重置</button>
          </div>
        </div>
      </div>

      <div class="flex items-center mt-8 py-2">
        <button type="button" class="btn disabled:btn-disabled btn-secondary btn-medium">
          <i class="ri-arrow-left-line mr-1"></i>
          上一步
        </button>
        <button type="button" class="btn disabled:btn-disabled btn-primary btn-medium ml-auto"
          (click)="save()"
        >保存并处理</button>
      </div>
    </div>

    <div class="grow max-w-[50%] relative flex flex-col pl-4 py-4 border-l border-y border-solid border-divider-regular rounded-xl">
      <header class="pl-5 pt-4 pr-4 pb-3 border-b border-divider-subtle">
        <div class="">
          <div class="text-text-accent system-2xs-semibold-uppercase uppercase px-1 mb-1">预览</div>
          <div class="flex items-center gap-1">
            <div class="flex items-center h-6 px-1 rounded-md hover:bg-state-base-hover select-none"
              [cdkMenuTriggerFor]="files"
            >
              <div class="flex items-center space-x-0.5">
                @if (selectedFile()) {
                  <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="remixicon shrink-0 w-5 h-5 text-[#2684FF]">
                    <path d="M16 2L21 7V21.0082C21 21.556 20.5551 22 20.0066 22H3.9934C3.44476 22 3 21.5447 3 21.0082V2.9918C3 2.44405 3.44495 2 3.9934 2H16ZM14 8V12.989L12 11L10.0108 13L10 8H8V16H10L12 14L14 16H16V8H14Z"></path>
                  </svg>
                  <span class="system-md-semibold max-w-[200px] truncate text-text-primary">
                    {{selectedFile().file.name}}
                  </span>
                } @else {
                  <div>
                    选择文件进行预览
                  </div>
                }
                <i class="ri-arrow-down-s-line"></i>
              </div>
            </div>
            @if (estimateFile()) {
              <div class="inline-flex items-center px-[5px] h-5 rounded-[5px] border border-divider-deep leading-3 text-text-tertiary system-2xs-medium-uppercase">{{estimateFile().docs.length}} 预估块</div>
            }
          </div>
        </div>
      </header>

      <main class="py-5 px-6 w-full grow space-y-6 overflow-auto">
        @for (chunk of estimateFile()?.docs; track chunk; let i = $index) {
          <div class="space-y-2">
            <div class="flex items-center text-text-secondary text-sm font-medium">
              <i class="ri-text-block mr-1"></i>
              <p class="flex gap-2 ml-0.5">
                <span>Chunk-{{i}}</span>
                <span>·</span>
                <span>{{chunk.pageContent.length}} characters</span>
              </p>
            </div>
            <div class="text-text-primary text-sm">{{chunk.pageContent}}</div>
          </div>
        } @empty {
          @if (estimateFile()?.error) {
            <div class="text-text-warning">
              {{estimateFile()?.error}}
            </div>
          }
        }
      </main>

      @if (estimating()) {
        <ngm-spin class="absolute w-full h-full left-0 top-0"/>
      }
    </div>
  </div>

  <ng-template #files>
    <div cdkMenu class="cdk-menu__medium">
      @for (file of fileList(); track file) {
        <div cdkMenuItem (click)="selectedFile.set(file)">
          {{ file.file.name }}
        </div>
      }
    </div>
  </ng-template>
}

@if (step() === 2) {
  <div class="flex justify-center w-full max-h-full h-full overflow-y-auto">
    <div class="grow shrink-0 h-full max-w-[960px] overflow-y-auto px-14 sm:px-16">
      <div class="mx-auto max-w-[640px]">
        <div class="pt-10">
          <div class="mb-1 text-xl leading-[22px] font-semibold text-text-primary">🎉 文档已上传</div>
          <div class="mb-7 text-[13px] leading-4 text-text-tertiary">
            文档已上传至知识库： 标准类型知识库 ，你可以在知识库的文档列表中找到它。
          </div>
        </div>
        <div class="h-5 flex items-center mb-3">
          <div class="flex items-center justify-between text-gray-900 font-medium text-sm mr-2">嵌入已完成</div>
        </div>
        <div class="flex flex-col gap-0.5 pb-2">
          @for (item of fileList(); track item.doc) {
            <div class="relative h-[26px] bg-components-progress-bar-bg rounded-md overflow-hidden">
              <div class="flex gap-1 pl-[6px] pr-2 h-full items-center z-[1]">
                <svg
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  fill="currentColor"
                  class="remixicon text-[#2684FF] shrink-0 size-4"
                >
                  <path
                    d="M16 2L21 7V21.0082C21 21.556 20.5551 22 20.0066 22H3.9934C3.44476 22 3 21.5447 3 21.0082V2.9918C3 2.44405 3.44495 2 3.9934 2H16ZM14 8V12.989L12 11L10.0108 13L10 8H8V16H10L12 14L14 16H16V8H14Z"
                  ></path>
                </svg>
                <div
                  class="grow flex items-center gap-1 w-0"
                  [title]="item.storageFile.originalName"
                >
                  <div class="text-sm truncate">{{item.storageFile.originalName}}</div>
                </div>

                @if (item.doc?.status === 'running') {
                  <i class="ri-loader-2-line flex justify-center items-center w-3.5 h-3.5 animate-spin"></i>
                } @else if (item.doc?.status === 'finish') {
                  <i class="ri-checkbox-circle-fill text-text-success"></i>
                } @else if (item.doc?.status === 'error') {
                  <i class="ri-close-circle-fill text-text-waring"
                    [matTooltip]="item.doc?.processMsg"
                  ></i>
                }
              </div>
            </div>
          }
        </div>
        <hr class="my-3 h-[1px] bg-divider-subtle border-0" />
        <div class="flex flex-col gap-1">
          <div class="flex items-center gap-1 py-0.5 min-h-5 text-sm">
            <div class="w-[200px] text-text-tertiary overflow-hidden text-ellipsis whitespace-nowrap shrink-0">
              分段模式
            </div>
            <div class="grow flex items-center gap-1 text-text-secondary">自定义</div>
          </div>
          <div class="flex items-center gap-1 py-0.5 min-h-5 text-sm">
            <div class="w-[200px] text-text-tertiary overflow-hidden text-ellipsis whitespace-nowrap shrink-0">
              最大分段长度
            </div>
            <div class="grow flex items-center gap-1 text-text-secondary">500</div>
          </div>
          <div class="flex gap-1 py-0.5 min-h-5 text-sm !items-start pt-1">
            <div class="w-[200px] text-text-tertiary overflow-hidden text-ellipsis whitespace-nowrap shrink-0">
              文本预处理规则
            </div>
            <div class="grow flex items-center gap-1 text-text-secondary">
              替换掉连续的空格、换行符和制表符,删除所有 URL 和电子邮件地址
            </div>
          </div>
          <div class="flex items-center gap-1 py-0.5 min-h-5 text-sm">
            <div class="w-[200px] text-text-tertiary overflow-hidden text-ellipsis whitespace-nowrap shrink-0">
              索引方式
            </div>
            <div class="grow flex items-center gap-1 text-text-secondary">
              高质量
            </div>
          </div>
          <div class="flex items-center gap-1 py-0.5 min-h-5 text-sm">
            <div class="w-[200px] text-text-tertiary overflow-hidden text-ellipsis whitespace-nowrap shrink-0">
              检索设置
            </div>
            <div class="grow flex items-center gap-1 text-text-secondary">
              <i class="ri-bnb-line"></i>
              向量检索
            </div>
          </div>
        </div>
        <div class="flex items-center gap-2 my-10">
          <button type="button" class="btn disabled:btn-disabled btn-secondary btn-medium w-fit">
            <i class="ri-terminal-box-line"></i>
            <span>Access the API</span></button
          >
          <button type="button" class="btn disabled:btn-disabled btn-primary btn-medium w-fit"
            (click)="apply()">
            <span>前往文档</span>
            <i class="ri-arrow-right-line"></i>
          </button>
        </div>
      </div>
    </div>
    <div class="shrink-0 pt-[88px] pr-8 text-sm">
      <div class="flex flex-col gap-3 w-[328px] p-6 text-text-tertiary bg-gray-50 rounded-xl">
        <div class="flex justify-center items-center w-10 h-10 bg-components-card-bg rounded-[10px] shadow-lg">
          <i class="ri-book-open-line text-xl text-purple-500"></i>
        </div>
        <div class="text-base font-semibold text-text-secondary">接下来做什么</div>
        <div class="text-text-tertiary">
          当文档完成索引处理后，知识库即可集成至应用内作为上下文使用，你可以在提示词编排页找到上下文设置。你也可以创建成可独立使用的
          ChatGPT 索引插件发布。
        </div>
      </div>
    </div>
  </div>
  
}
