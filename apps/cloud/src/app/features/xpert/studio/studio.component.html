<mat-sidenav-container class="flex-1 h-full">
  <mat-sidenav #sidenav opened [mode]="isMobile() ? 'over' : 'side'" class="w-[400px]"> </mat-sidenav>
  <mat-sidenav-content>
    <f-flow fDraggable (fLoaded)="onLoaded()" (fCreateConnection)="addConnection($event)"
      (fReassignConnection)="reassignConnection($event)"
      (fSelectionChange)="selectionChanged($event)"
      (contextmenu)="onContextMenu($event)"
      [cdkContextMenuTriggerFor]="menu.template"
      (cdkContextMenuClosed)="menu.dispose()">
      <f-background>
        <f-circle-pattern></f-circle-pattern>
      </f-background>
      <f-line-alignment></f-line-alignment>
      <f-selection-area></f-selection-area>

      <f-canvas fZoom [fZoomStep]="0.02" [fZoomDblClickStep]="0.1">
        <f-connection-for-create></f-connection-for-create>
        <f-snap-connection fType="bezier" [fSnapThreshold]="100"></f-snap-connection>
        @for (connection of connections(); track connection.key) {
          <f-connection [fType]="connection.type==='agent' || connection.type==='xpert' ? EFConnectionType.BEZIER : EFConnectionType.STRAIGHT"
            [fReassignDisabled]="false"
            [fOutputId]="connection.from + '/' + connection.type"
            [fInputId]="connection.to">
          </f-connection>
        }

        @for (node of nodes(); track node.key + node.hash) {
          <div class="w-[240px] group relative pb-1 shadow-xs border border-transparent rounded-[15px] bg-workflow-block-bg hover:shadow-lg"
            fNode [fNodeId]="node.key"
            [fNodeParentId]="node.parentId"
            fDragHandle
            [fNodePosition]="node.position"
            [fNodeSize]="node.size"
            (fNodePositionChange)="moveNode($event, node.key)"
            (fNodeSizeChange)="onSizeChange($event, node)"
            (mousedown)="onMouseDown($event)"
            (click)="onSelectNode($event, node)"
          >
          @switch (node.type) {
            @case('agent') {
              <xpert-studio-node-agent [node]="node" [isRoot]="!!node.entity.xpertId" class=""/>
            }
            @case('knowledge') {
              <xpert-studio-node-knowledge [node]="node" class=""/>
            }
            @case('toolset') {
              <xpert-studio-node-toolset [node]="node" class=""/>
            }
          }
          </div>
        }

        @for (group of xperts(); track group.key) {
          <div fGroup [fGroupId]="group.key" [fGroupParentId]="group.parentId" [fGroupPosition]="group.position"
            [fGroupSize]="group.size" fDragHandle
            (fGroupPositionChange)="moveXpertGroup($event, group.key)"
            (fGroupSizeChange)="resizeXpertGroup($event, group.key)"
          >
            <div class="group-title">{{ group.entity.title }}</div>
            <div fResizeHandle [fResizeHandleType]="eResizeHandleType.LEFT_TOP"></div>
            <div fResizeHandle [fResizeHandleType]="eResizeHandleType.RIGHT_TOP"></div>
            <div fResizeHandle [fResizeHandleType]="eResizeHandleType.LEFT_BOTTOM"></div>
            <div fResizeHandle [fResizeHandleType]="eResizeHandleType.RIGHT_BOTTOM"></div>

            <div fNodeInput [fInputId]="group.key" fInputConnectableSide="top" class="top"></div>

            <div class="absolute right-1 top-1 flex items-center p-0.5 bg-white rounded-lg border-[0.5px] border-gray-100 shadow-xs text-gray-500">
              <div class="flex items-center justify-center w-6 h-6 rounded-md cursor-pointer
                hover:bg-black/5"
                (click)="expandXpertTeam(group)">
                @if (group.expanded) {
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11.9995 13.4995 16.9493 18.4493 15.535 19.8635 12.9995 17.3279 12.9995 22.9995H10.9995L10.9995 17.3279 8.46646 19.861 7.05225 18.4468 11.9995 13.4995ZM10.9995.999512 10.9995 6.67035 8.46451 4.13535 7.05029 5.54956 12 10.4995 16.9497 5.54977 15.5355 4.13555 12.9995 6.67157V.999512L10.9995.999512Z"></path></svg>
                } @else {
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11.9995 0.499512L16.9493 5.44926L15.535 6.86347L12.9995 4.32794V9.99951H10.9995L10.9995 4.32794L8.46646 6.86099L7.05225 5.44678L11.9995 0.499512ZM10.9995 13.9995L10.9995 19.6704L8.46451 17.1353L7.05029 18.5496L12 23.4995L16.9497 18.5498L15.5355 17.1356L12.9995 19.6716V13.9995H10.9995Z"></path></svg>
                }
              </div>
            </div>
          </div>
        }
      </f-canvas>

      <f-selection-area></f-selection-area>
      <f-minimap></f-minimap>
    </f-flow>

    <xpert-studio-toolbar class="flex items-center mt-1 gap-2 absolute left-4 bottom-4 z-[9]" />

    <xpert-studio-header class="absolute top-0 left-0 z-10 flex items-center justify-between w-full px-3 h-14" />

    <xpert-studio-panel class="absolute top-14 right-0 bottom-2 flex z-10 outline-none" [(visible)]="panelVisible" />
  </mat-sidenav-content>
</mat-sidenav-container>

<xpert-studio-context-menu #menu="menuComponent" />
